<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="stylesheet" href="resources/bootstrap.min.css">
        <link rel="stylesheet" href="resources/style.css">
        <link rel="stylesheet" href="resources/jquery.iviewer.css">

        <title>
            Source Code: SmartFactory/DatabaseWorkers/MSSQL_DBWorker.php - SmartFactory Library
        </title>
    </head>

    <body>
        <div id="navigation">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <nav class="navbar">
                    <ul class="nav navbar-nav">
                        
                        
                        <li>
                            <a href="index.html" class="">
                                Overview
                            </a>
                        </li>
                        
                        <li>
                            <a href="classes.html" class="">
                                Classes
                            </a>
                        </li>
                        
                        <li>
                            <a href="interfaces.html" class="">
                                Interfaces
                            </a>
                        </li>
                        
                        <li>
                            <a href="functions.html" class="">
                                Functions
                            </a>
                        </li>
                        
                        <li>
                            <a href="structure.html" class="">
                                Structure
                            </a>
                        </li>
                        

                    </ul>

                    <form id="search" class="pull-right">
                        <input type="text" name="q" class="form-control text" placeholder="Search class, function or namespace">
                    </form>
                </nav>
            </div>
        </div>
    </div>
</div>

        
        <div id="breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
            
                
                
                <ol class="breadcrumb pull-left">
                        
                        
 

                        <li class="active"></li>
                </ol>
                
            </div>
        </div>
    </div>
</div>

        
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h2>Source Code: SmartFactory/DatabaseWorkers/MSSQL_DBWorker.php</h2>

<div id="source"><pre class="code"><code><span class="line" id="1">   1: </span><span class="xlang">&lt;?php</span>
<span class="line" id="2">   2: </span><span class="php-comment">/**
</span><span class="line" id="3">   3: </span><span class="php-comment"> * This file contains the implementation of the abstract base class DBWorker
</span><span class="line" id="4">   4: </span><span class="php-comment"> * for the MS SQL database using the extension mysqli.
</span><span class="line" id="5">   5: </span><span class="php-comment"> *
</span><span class="line" id="6">   6: </span><span class="php-comment"> * @package Database
</span><span class="line" id="7">   7: </span><span class="php-comment"> *
</span><span class="line" id="8">   8: </span><span class="php-comment"> * @author Oleg Schildt
</span><span class="line" id="9">   9: </span><span class="php-comment"> */</span>
<span class="line" id="10">  10: </span>
<span class="line" id="11">  11: </span><span class="php-keyword1">namespace</span> SmartFactory\DatabaseWorkers;
<span class="line" id="12">  12: </span>
<span class="line" id="13">  13: </span><span class="php-keyword1">use</span> <span class="php-keyword1">function</span> \SmartFactory\debugger;
<span class="line" id="14">  14: </span>
<span class="line" id="15">  15: </span><span class="php-comment">/**
</span><span class="line" id="16">  16: </span><span class="php-comment"> * This is the class for the MS SQL database using the extension sqlsrv.
</span><span class="line" id="17">  17: </span><span class="php-comment"> *
</span><span class="line" id="18">  18: </span><span class="php-comment"> * This is a wrapper around the database connectivity. It offers an universal
</span><span class="line" id="19">  19: </span><span class="php-comment"> * common way for working with databases of different types. Currently, MySQL, PostgreSQL and
</span><span class="line" id="20">  20: </span><span class="php-comment"> * MS SQL are supported. If in the future, there will be a better solution, or
</span><span class="line" id="21">  21: </span><span class="php-comment"> * the current solution turns out to be inefficient in a new version of PHP,
</span><span class="line" id="22">  22: </span><span class="php-comment"> * we can easily reimplement the DB wrapper without touching the business logic code.
</span><span class="line" id="23">  23: </span><span class="php-comment"> * Adding support for new database types is also much easier with this wrapping approach.
</span><span class="line" id="24">  24: </span><span class="php-comment"> *
</span><span class="line" id="25">  25: </span><span class="php-comment"> * @see PostgreSQL_DBWorker
</span><span class="line" id="26">  26: </span><span class="php-comment"> * @see MySQL_DBWorker
</span><span class="line" id="27">  27: </span><span class="php-comment"> *
</span><span class="line" id="28">  28: </span><span class="php-comment"> * @author Oleg Schildt
</span><span class="line" id="29">  29: </span><span class="php-comment"> */</span>
<span class="line" id="30">  30: </span><span class="php-keyword1">class</span> MSSQL_DBWorker <span class="php-keyword1">extends</span> DBWorker
<span class="line" id="31">  31: </span>{
<span class="line" id="32">  32: </span>    <span class="php-comment">/**
</span><span class="line" id="33">  33: </span><span class="php-comment">     * Stores the resource handle of the opened connection.
</span><span class="line" id="34">  34: </span><span class="php-comment">     *
</span><span class="line" id="35">  35: </span><span class="php-comment">     * @var resource
</span><span class="line" id="36">  36: </span><span class="php-comment">     *
</span><span class="line" id="37">  37: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="38">  38: </span><span class="php-comment">     */</span>
<span class="line" id="39">  39: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$connection</span> = <span class="php-keyword1">null</span>;
<span class="line" id="40">  40: </span>
<span class="line" id="41">  41: </span>    <span class="php-comment">/**
</span><span class="line" id="42">  42: </span><span class="php-comment">     * Stores the resource handle of the statement
</span><span class="line" id="43">  43: </span><span class="php-comment">     * of the last executed query.
</span><span class="line" id="44">  44: </span><span class="php-comment">     *
</span><span class="line" id="45">  45: </span><span class="php-comment">     * @var resource
</span><span class="line" id="46">  46: </span><span class="php-comment">     *
</span><span class="line" id="47">  47: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="48">  48: </span><span class="php-comment">     */</span>
<span class="line" id="49">  49: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$statement</span> = <span class="php-keyword1">null</span>;
<span class="line" id="50">  50: </span>
<span class="line" id="51">  51: </span>    <span class="php-comment">/**
</span><span class="line" id="52">  52: </span><span class="php-comment">     * Internal variable for storing of the last prepared query.
</span><span class="line" id="53">  53: </span><span class="php-comment">     *
</span><span class="line" id="54">  54: </span><span class="php-comment">     * @var string
</span><span class="line" id="55">  55: </span><span class="php-comment">     *
</span><span class="line" id="56">  56: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="57">  57: </span><span class="php-comment">     */</span>
<span class="line" id="58">  58: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$prepared_query</span> = <span class="php-keyword1">null</span>;
<span class="line" id="59">  59: </span>
<span class="line" id="60">  60: </span>    <span class="php-comment">/**
</span><span class="line" id="61">  61: </span><span class="php-comment">     * Stores the state whether the last query was an insert or not.
</span><span class="line" id="62">  62: </span><span class="php-comment">     *
</span><span class="line" id="63">  63: </span><span class="php-comment">     * @var boolean
</span><span class="line" id="64">  64: </span><span class="php-comment">     *
</span><span class="line" id="65">  65: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="66">  66: </span><span class="php-comment">     */</span>
<span class="line" id="67">  67: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$last_query_is_insert</span> = <span class="php-keyword1">false</span>;
<span class="line" id="68">  68: </span>
<span class="line" id="69">  69: </span>    <span class="php-comment">/**
</span><span class="line" id="70">  70: </span><span class="php-comment">     * Internal variable for storing of the current fetched row
</span><span class="line" id="71">  71: </span><span class="php-comment">     * from the result of the last retrieving query.
</span><span class="line" id="72">  72: </span><span class="php-comment">     *
</span><span class="line" id="73">  73: </span><span class="php-comment">     * @var array
</span><span class="line" id="74">  74: </span><span class="php-comment">     *
</span><span class="line" id="75">  75: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="76">  76: </span><span class="php-comment">     */</span>
<span class="line" id="77">  77: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$row</span> = <span class="php-keyword1">null</span>;
<span class="line" id="78">  78: </span>
<span class="line" id="79">  79: </span>    <span class="php-comment">/**
</span><span class="line" id="80">  80: </span><span class="php-comment">     * Internal variable for storing of the column names
</span><span class="line" id="81">  81: </span><span class="php-comment">     * from the result of the last retrieving query.
</span><span class="line" id="82">  82: </span><span class="php-comment">     *
</span><span class="line" id="83">  83: </span><span class="php-comment">     * @var array
</span><span class="line" id="84">  84: </span><span class="php-comment">     *
</span><span class="line" id="85">  85: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="86">  86: </span><span class="php-comment">     */</span>
<span class="line" id="87">  87: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$field_names</span> = <span class="php-keyword1">null</span>;
<span class="line" id="88">  88: </span>
<span class="line" id="89">  89: </span>    <span class="php-comment">/**
</span><span class="line" id="90">  90: </span><span class="php-comment">     * Internal variable for storing of the parameters
</span><span class="line" id="91">  91: </span><span class="php-comment">     * of the last prepared query.
</span><span class="line" id="92">  92: </span><span class="php-comment">     *
</span><span class="line" id="93">  93: </span><span class="php-comment">     * @var array
</span><span class="line" id="94">  94: </span><span class="php-comment">     *
</span><span class="line" id="95">  95: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="96">  96: </span><span class="php-comment">     */</span>
<span class="line" id="97">  97: </span>    <span class="php-keyword1">protected</span> <span class="php-var">$query_parameters</span> = <span class="php-keyword1">null</span>;
<span class="line" id="98">  98: </span>
<span class="line" id="99">  99: </span>    <span class="php-comment">/**
</span><span class="line" id="100"> 100: </span><span class="php-comment">     * Retrieves the last errors ocurend while execution of the query.
</span><span class="line" id="101"> 101: </span><span class="php-comment">     *
</span><span class="line" id="102"> 102: </span><span class="php-comment">     * @return string
</span><span class="line" id="103"> 103: </span><span class="php-comment">     * Returns the string of errors separated by the new line symbol.
</span><span class="line" id="104"> 104: </span><span class="php-comment">     *
</span><span class="line" id="105"> 105: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="106"> 106: </span><span class="php-comment">     */</span>
<span class="line" id="107"> 107: </span>    <span class="php-keyword1">protected</span> <span class="php-keyword1">function</span> sys_get_errors()
<span class="line" id="108"> 108: </span>    {
<span class="line" id="109"> 109: </span>        <span class="php-var">$errors</span> = sqlsrv_errors(SQLSRV_ERR_ERRORS);
<span class="line" id="110"> 110: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$errors</span>)) {
<span class="line" id="111"> 111: </span>            <span class="php-keyword1">return</span> <span class="php-quote">&quot;&quot;</span>;
<span class="line" id="112"> 112: </span>        }
<span class="line" id="113"> 113: </span>
<span class="line" id="114"> 114: </span>        <span class="php-var">$message_array</span> = [];
<span class="line" id="115"> 115: </span>
<span class="line" id="116"> 116: </span>        <span class="php-keyword1">foreach</span> (<span class="php-var">$errors</span> <span class="php-keyword1">as</span> <span class="php-var">$error</span>) {
<span class="line" id="117"> 117: </span>            <span class="php-var">$message_array</span>[<span class="php-var">$error</span>[<span class="php-quote">'message'</span>]] = <span class="php-var">$error</span>[<span class="php-quote">'message'</span>];
<span class="line" id="118"> 118: </span>        }
<span class="line" id="119"> 119: </span>
<span class="line" id="120"> 120: </span>        <span class="php-keyword1">return</span> <span class="php-keyword2">implode</span>(<span class="php-quote">&quot;\n&quot;</span>, <span class="php-var">$message_array</span>);
<span class="line" id="121"> 121: </span>    } <span class="php-comment">// sys_get_errors</span>
<span class="line" id="122"> 122: </span>
<span class="line" id="123"> 123: </span>    <span class="php-comment">/**
</span><span class="line" id="124"> 124: </span><span class="php-comment">     * Creates a clone of the dbworker that is using the same open
</span><span class="line" id="125"> 125: </span><span class="php-comment">     * connection.
</span><span class="line" id="126"> 126: </span><span class="php-comment">     *
</span><span class="line" id="127"> 127: </span><span class="php-comment">     * This might be useful if you want to execute some additional
</span><span class="line" id="128"> 128: </span><span class="php-comment">     * queries while iteration through the active results of a select query.
</span><span class="line" id="129"> 129: </span><span class="php-comment">     *
</span><span class="line" id="130"> 130: </span><span class="php-comment">     * @return MSSQL_DBWorker
</span><span class="line" id="131"> 131: </span><span class="php-comment">     * Returns the clone of this dbworker.
</span><span class="line" id="132"> 132: </span><span class="php-comment">     *
</span><span class="line" id="133"> 133: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="134"> 134: </span><span class="php-comment">     */</span>
<span class="line" id="135"> 135: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> create_clone()
<span class="line" id="136"> 136: </span>    {
<span class="line" id="137"> 137: </span>        <span class="php-var">$cln</span> = <span class="php-keyword1">new</span> MSSQL_DBWorker();
<span class="line" id="138"> 138: </span>
<span class="line" id="139"> 139: </span>        <span class="php-var">$cln</span>-&gt;is_clone = <span class="php-keyword1">true</span>;
<span class="line" id="140"> 140: </span>
<span class="line" id="141"> 141: </span>        <span class="php-var">$cln</span>-&gt;db_server = <span class="php-var">$this</span>-&gt;db_server;
<span class="line" id="142"> 142: </span>        <span class="php-var">$cln</span>-&gt;db_port = <span class="php-var">$this</span>-&gt;db_port;
<span class="line" id="143"> 143: </span>        <span class="php-var">$cln</span>-&gt;db_name = <span class="php-var">$this</span>-&gt;db_name;
<span class="line" id="144"> 144: </span>        <span class="php-var">$cln</span>-&gt;db_user = <span class="php-var">$this</span>-&gt;db_user;
<span class="line" id="145"> 145: </span>        <span class="php-var">$cln</span>-&gt;db_password = <span class="php-var">$this</span>-&gt;db_password;
<span class="line" id="146"> 146: </span>
<span class="line" id="147"> 147: </span>        <span class="php-keyword1">return</span> <span class="php-var">$cln</span>;
<span class="line" id="148"> 148: </span>    } <span class="php-comment">// create_clone</span>
<span class="line" id="149"> 149: </span>
<span class="line" id="150"> 150: </span>    <span class="php-comment">/**
</span><span class="line" id="151"> 151: </span><span class="php-comment">     * Constructor.
</span><span class="line" id="152"> 152: </span><span class="php-comment">     *
</span><span class="line" id="153"> 153: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="154"> 154: </span><span class="php-comment">     */</span>
<span class="line" id="155"> 155: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> __construct()
<span class="line" id="156"> 156: </span>    {
<span class="line" id="157"> 157: </span>    } <span class="php-comment">// __construct</span>
<span class="line" id="158"> 158: </span>
<span class="line" id="159"> 159: </span>    <span class="php-comment">/**
</span><span class="line" id="160"> 160: </span><span class="php-comment">     * Destructor.
</span><span class="line" id="161"> 161: </span><span class="php-comment">     *
</span><span class="line" id="162"> 162: </span><span class="php-comment">     * @return void
</span><span class="line" id="163"> 163: </span><span class="php-comment">     *
</span><span class="line" id="164"> 164: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="165"> 165: </span><span class="php-comment">     */</span>
<span class="line" id="166"> 166: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> __destruct()
<span class="line" id="167"> 167: </span>    {
<span class="line" id="168"> 168: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;is_clone) {
<span class="line" id="169"> 169: </span>            <span class="php-var">$this</span>-&gt;close_connection();
<span class="line" id="170"> 170: </span>        }
<span class="line" id="171"> 171: </span>    } <span class="php-comment">// __destruct</span>
<span class="line" id="172"> 172: </span>
<span class="line" id="173"> 173: </span>    <span class="php-comment">/**
</span><span class="line" id="174"> 174: </span><span class="php-comment">     * Initializes the dbworker with connection paramters.
</span><span class="line" id="175"> 175: </span><span class="php-comment">     *
</span><span class="line" id="176"> 176: </span><span class="php-comment">     * @param array $parameters
</span><span class="line" id="177"> 177: </span><span class="php-comment">     * Connection settings as an associative array in the form key =&gt; value:
</span><span class="line" id="178"> 178: </span><span class="php-comment">     *
</span><span class="line" id="179"> 179: </span><span class="php-comment">     * - $parameters[&quot;db_server&quot;] - server address.
</span><span class="line" id="180"> 180: </span><span class="php-comment">     * - $parameters[&quot;db_port&quot;] - server port.
</span><span class="line" id="181"> 181: </span><span class="php-comment">     * - $parameters[&quot;db_name&quot;] - database name.
</span><span class="line" id="182"> 182: </span><span class="php-comment">     * - $parameters[&quot;db_user&quot;] - user name.
</span><span class="line" id="183"> 183: </span><span class="php-comment">     * - $parameters[&quot;db_password&quot;] - user password.
</span><span class="line" id="184"> 184: </span><span class="php-comment">     *
</span><span class="line" id="185"> 185: </span><span class="php-comment">     * @return void
</span><span class="line" id="186"> 186: </span><span class="php-comment">     *
</span><span class="line" id="187"> 187: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="188"> 188: </span><span class="php-comment">     */</span>
<span class="line" id="189"> 189: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> init(<span class="php-var">$parameters</span>)
<span class="line" id="190"> 190: </span>    {
<span class="line" id="191"> 191: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$parameters</span>[<span class="php-quote">&quot;db_server&quot;</span>])) {
<span class="line" id="192"> 192: </span>            <span class="php-var">$this</span>-&gt;db_server = <span class="php-var">$parameters</span>[<span class="php-quote">&quot;db_server&quot;</span>];
<span class="line" id="193"> 193: </span>        }
<span class="line" id="194"> 194: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$parameters</span>[<span class="php-quote">&quot;db_port&quot;</span>])) {
<span class="line" id="195"> 195: </span>            <span class="php-var">$this</span>-&gt;db_server = <span class="php-var">$parameters</span>[<span class="php-quote">&quot;db_port&quot;</span>];
<span class="line" id="196"> 196: </span>        }
<span class="line" id="197"> 197: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$parameters</span>[<span class="php-quote">&quot;db_name&quot;</span>])) {
<span class="line" id="198"> 198: </span>            <span class="php-var">$this</span>-&gt;db_name = <span class="php-var">$parameters</span>[<span class="php-quote">&quot;db_name&quot;</span>];
<span class="line" id="199"> 199: </span>        }
<span class="line" id="200"> 200: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$parameters</span>[<span class="php-quote">&quot;db_user&quot;</span>])) {
<span class="line" id="201"> 201: </span>            <span class="php-var">$this</span>-&gt;db_user = <span class="php-var">$parameters</span>[<span class="php-quote">&quot;db_user&quot;</span>];
<span class="line" id="202"> 202: </span>        }
<span class="line" id="203"> 203: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$parameters</span>[<span class="php-quote">&quot;db_password&quot;</span>])) {
<span class="line" id="204"> 204: </span>            <span class="php-var">$this</span>-&gt;db_password = <span class="php-var">$parameters</span>[<span class="php-quote">&quot;db_password&quot;</span>];
<span class="line" id="205"> 205: </span>        }
<span class="line" id="206"> 206: </span>    } <span class="php-comment">// init</span>
<span class="line" id="207"> 207: </span>
<span class="line" id="208"> 208: </span>    <span class="php-comment">/**
</span><span class="line" id="209"> 209: </span><span class="php-comment">     * Checks whether the extension (sqlsrv) is installed which is required for work with
</span><span class="line" id="210"> 210: </span><span class="php-comment">     * the MySQL database.
</span><span class="line" id="211"> 211: </span><span class="php-comment">     *
</span><span class="line" id="212"> 212: </span><span class="php-comment">     * @return boolean
</span><span class="line" id="213"> 213: </span><span class="php-comment">     * The method should return true if the extension is installed, otherwise false.
</span><span class="line" id="214"> 214: </span><span class="php-comment">     *
</span><span class="line" id="215"> 215: </span><span class="php-comment">     * @see MSSQL_DBWorker::get_extension_name()
</span><span class="line" id="216"> 216: </span><span class="php-comment">     *
</span><span class="line" id="217"> 217: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="218"> 218: </span><span class="php-comment">     */</span>
<span class="line" id="219"> 219: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> is_extension_installed()
<span class="line" id="220"> 220: </span>    {
<span class="line" id="221"> 221: </span>        <span class="php-keyword1">return</span> <span class="php-keyword2">function_exists</span>(<span class="php-quote">&quot;sqlsrv_connect&quot;</span>);
<span class="line" id="222"> 222: </span>    } <span class="php-comment">// is_extension_installed</span>
<span class="line" id="223"> 223: </span>
<span class="line" id="224"> 224: </span>    <span class="php-comment">/**
</span><span class="line" id="225"> 225: </span><span class="php-comment">     * Returns the name of the required PHP extension - &quot;sqlsrv&quot;.
</span><span class="line" id="226"> 226: </span><span class="php-comment">     *
</span><span class="line" id="227"> 227: </span><span class="php-comment">     * @return string
</span><span class="line" id="228"> 228: </span><span class="php-comment">     * Returns the name of the required PHP extension - &quot;sqlsrv&quot;.
</span><span class="line" id="229"> 229: </span><span class="php-comment">     *
</span><span class="line" id="230"> 230: </span><span class="php-comment">     * @see MSSQL_DBWorker::is_extension_installed()
</span><span class="line" id="231"> 231: </span><span class="php-comment">     *
</span><span class="line" id="232"> 232: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="233"> 233: </span><span class="php-comment">     */</span>
<span class="line" id="234"> 234: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> get_extension_name()
<span class="line" id="235"> 235: </span>    {
<span class="line" id="236"> 236: </span>        <span class="php-keyword1">return</span> <span class="php-quote">&quot;sqlsrv&quot;</span>;
<span class="line" id="237"> 237: </span>    } <span class="php-comment">// get_extension_name</span>
<span class="line" id="238"> 238: </span>
<span class="line" id="239"> 239: </span>    <span class="php-comment">/**
</span><span class="line" id="240"> 240: </span><span class="php-comment">     * Returns the name of the supported database - &quot;Microsoft SQL Server&quot;.
</span><span class="line" id="241"> 241: </span><span class="php-comment">     *
</span><span class="line" id="242"> 242: </span><span class="php-comment">     * @return string
</span><span class="line" id="243"> 243: </span><span class="php-comment">     * Returns the name of the supported database - &quot;Microsoft SQL Server&quot;.
</span><span class="line" id="244"> 244: </span><span class="php-comment">     *
</span><span class="line" id="245"> 245: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="246"> 246: </span><span class="php-comment">     */</span>
<span class="line" id="247"> 247: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> get_rdbms_name()
<span class="line" id="248"> 248: </span>    {
<span class="line" id="249"> 249: </span>        <span class="php-keyword1">return</span> <span class="php-quote">&quot;Microsoft SQL Server&quot;</span>;
<span class="line" id="250"> 250: </span>    } <span class="php-comment">// get_rdbms_name</span>
<span class="line" id="251"> 251: </span>
<span class="line" id="252"> 252: </span>    <span class="php-comment">/**
</span><span class="line" id="253"> 253: </span><span class="php-comment">     * Returns the connection state.
</span><span class="line" id="254"> 254: </span><span class="php-comment">     *
</span><span class="line" id="255"> 255: </span><span class="php-comment">     * @return boolean
</span><span class="line" id="256"> 256: </span><span class="php-comment">     * Returns true if the connection is open, otherwise false.
</span><span class="line" id="257"> 257: </span><span class="php-comment">     *
</span><span class="line" id="258"> 258: </span><span class="php-comment">     * @see DBWorker::check_connection()
</span><span class="line" id="259"> 259: </span><span class="php-comment">     * @see MSSQL_DBWorker::connect()
</span><span class="line" id="260"> 260: </span><span class="php-comment">     * @see MSSQL_DBWorker::close_connection()
</span><span class="line" id="261"> 261: </span><span class="php-comment">     *
</span><span class="line" id="262"> 262: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="263"> 263: </span><span class="php-comment">     */</span>
<span class="line" id="264"> 264: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> is_connected()
<span class="line" id="265"> 265: </span>    {
<span class="line" id="266"> 266: </span>        <span class="php-keyword1">return</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;connection) &amp;&amp; <span class="php-keyword2">is_resource</span>(<span class="php-var">$this</span>-&gt;connection));
<span class="line" id="267"> 267: </span>    } <span class="php-comment">// is_connected</span>
<span class="line" id="268"> 268: </span>
<span class="line" id="269"> 269: </span>    <span class="php-comment">/**
</span><span class="line" id="270"> 270: </span><span class="php-comment">     * Establishes the connection to the database using the connection
</span><span class="line" id="271"> 271: </span><span class="php-comment">     * settings parameters specified by the initialization.
</span><span class="line" id="272"> 272: </span><span class="php-comment">     *
</span><span class="line" id="273"> 273: </span><span class="php-comment">     * @return void
</span><span class="line" id="274"> 274: </span><span class="php-comment">     *
</span><span class="line" id="275"> 275: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="276"> 276: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="277"> 277: </span><span class="php-comment">     *
</span><span class="line" id="278"> 278: </span><span class="php-comment">     * @see DBWorker::check_connection()
</span><span class="line" id="279"> 279: </span><span class="php-comment">     * @see MSSQL_DBWorker::is_connected()
</span><span class="line" id="280"> 280: </span><span class="php-comment">     * @see MSSQL_DBWorker::close_connection()
</span><span class="line" id="281"> 281: </span><span class="php-comment">     *
</span><span class="line" id="282"> 282: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="283"> 283: </span><span class="php-comment">     */</span>
<span class="line" id="284"> 284: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> connect()
<span class="line" id="285"> 285: </span>    {
<span class="line" id="286"> 286: </span>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;is_connected()) {
<span class="line" id="287"> 287: </span>            <span class="php-keyword1">return</span>;
<span class="line" id="288"> 288: </span>        }
<span class="line" id="289"> 289: </span>
<span class="line" id="290"> 290: </span>        sqlsrv_configure(<span class="php-quote">&quot;WarningsReturnAsErrors&quot;</span>, <span class="php-num">0</span>);
<span class="line" id="291"> 291: </span>
<span class="line" id="292"> 292: </span>        <span class="php-var">$this</span>-&gt;last_query = <span class="php-keyword1">null</span>;
<span class="line" id="293"> 293: </span>
<span class="line" id="294"> 294: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">isset</span>(<span class="php-var">$this</span>-&gt;connection) || !<span class="php-var">$this</span>-&gt;connection) {
<span class="line" id="295"> 295: </span>            <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;db_server) || <span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;db_user) || <span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;db_password)) {
<span class="line" id="296"> 296: </span>                <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-quote">&quot;Connection data is incomplete&quot;</span>, DBWorker::ERR_CONNECTION_DATA_INCOMPLETE);
<span class="line" id="297"> 297: </span>            }
<span class="line" id="298"> 298: </span>
<span class="line" id="299"> 299: </span>            <span class="php-comment">/*
</span><span class="line" id="300"> 300: </span><span class="php-comment">            This new MSSQL dirver has a BIG problem. It sticks to the encoding
</span><span class="line" id="301"> 301: </span><span class="php-comment">            of the Windows and ignores the database and server collation.
</span><span class="line" id="302"> 302: </span><span class="php-comment">      
</span><span class="line" id="303"> 303: </span><span class="php-comment">            If you use the UTF-8, you have two options:
</span><span class="line" id="304"> 304: </span><span class="php-comment">      
</span><span class="line" id="305"> 305: </span><span class="php-comment">            1. Use NCHAR etc. types
</span><span class="line" id="306"> 306: </span><span class="php-comment">            2. Store the UTF-8 strings as is into the 1-byte fields like varchar etc.
</span><span class="line" id="307"> 307: </span><span class="php-comment">      
</span><span class="line" id="308"> 308: </span><span class="php-comment">            The variant 1 might be undesirable because of performance.
</span><span class="line" id="309"> 309: </span><span class="php-comment">      
</span><span class="line" id="310"> 310: </span><span class="php-comment">            The variant 2 might cause problems in contrast to the old MSSQL drivers.
</span><span class="line" id="311"> 311: </span><span class="php-comment">            E.g. if you have the Russian locale on your Windows, but the Latin collation
</span><span class="line" id="312"> 312: </span><span class="php-comment">            in the database, you have no chance for the variant 2. The driver will convert
</span><span class="line" id="313"> 313: </span><span class="php-comment">            the data, although it should not do that but send this as is!
</span><span class="line" id="314"> 314: </span><span class="php-comment">      
</span><span class="line" id="315"> 315: </span><span class="php-comment">            There is the option SQLSRV_ENC_BINARY that prevents any conversion, but it cannot
</span><span class="line" id="316"> 316: </span><span class="php-comment">            be used globally and it cannot be used for simple queries. It can be used only for
</span><span class="line" id="317"> 317: </span><span class="php-comment">            prepared queries. It would be so easy just to allow setting SQLSRV_ENC_BINARY
</span><span class="line" id="318"> 318: </span><span class="php-comment">            on connection level, but they did not do this!
</span><span class="line" id="319"> 319: </span><span class="php-comment">      
</span><span class="line" id="320"> 320: </span><span class="php-comment">            Thus, you have only the following choices:
</span><span class="line" id="321"> 321: </span><span class="php-comment">      
</span><span class="line" id="322"> 322: </span><span class="php-comment">            1. Store the unicode texts in NCHAR fields and use CharacterSet = UTF-8.
</span><span class="line" id="323"> 323: </span><span class="php-comment">            2. Store the unicode texts in normal fields and use only parametrized queries.
</span><span class="line" id="324"> 324: </span><span class="php-comment">               You have always to specify the type SQLSRV_ENC_BINARY for each paramter
</span><span class="line" id="325"> 325: </span><span class="php-comment">               explicitly.
</span><span class="line" id="326"> 326: </span><span class="php-comment">            3. Store the unicode texts in normal fields and ensure that the Windows locale
</span><span class="line" id="327"> 327: </span><span class="php-comment">               and the SQL Server are identical.
</span><span class="line" id="328"> 328: </span><span class="php-comment">      
</span><span class="line" id="329"> 329: </span><span class="php-comment">            Beacause of universality of the DBWorker independent of the database type,
</span><span class="line" id="330"> 330: </span><span class="php-comment">            I use the choise 3.
</span><span class="line" id="331"> 331: </span><span class="php-comment">            */</span>
<span class="line" id="332"> 332: </span>
<span class="line" id="333"> 333: </span>            <span class="php-var">$config</span> = [
<span class="line" id="334"> 334: </span>                <span class="php-quote">&quot;UID&quot;</span> =&gt; <span class="php-var">$this</span>-&gt;db_user,
<span class="line" id="335"> 335: </span>                <span class="php-quote">&quot;PWD&quot;</span> =&gt; <span class="php-var">$this</span>-&gt;db_password,
<span class="line" id="336"> 336: </span>                <span class="php-comment">//&quot;CharacterSet&quot; =&gt; &quot;UTF-8&quot;,</span>
<span class="line" id="337"> 337: </span>                <span class="php-quote">&quot;ReturnDatesAsStrings&quot;</span> =&gt; <span class="php-keyword1">true</span>,
<span class="line" id="338"> 338: </span>                <span class="php-quote">&quot;MultipleActiveResultSets&quot;</span> =&gt; <span class="php-keyword1">false</span>
<span class="line" id="339"> 339: </span>            ];
<span class="line" id="340"> 340: </span>
<span class="line" id="341"> 341: </span>            <span class="php-var">$this</span>-&gt;connection = @sqlsrv_connect(<span class="php-var">$this</span>-&gt;db_server, <span class="php-var">$config</span>);
<span class="line" id="342"> 342: </span>        }
<span class="line" id="343"> 343: </span>
<span class="line" id="344"> 344: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;connection) {
<span class="line" id="345"> 345: </span>            <span class="php-var">$err</span> = <span class="php-var">$this</span>-&gt;sys_get_errors();
<span class="line" id="346"> 346: </span>            <span class="php-var">$this</span>-&gt;connection = <span class="php-keyword1">null</span>;
<span class="line" id="347"> 347: </span>
<span class="line" id="348"> 348: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_CONNECTION_FAILED);
<span class="line" id="349"> 349: </span>        }
<span class="line" id="350"> 350: </span>
<span class="line" id="351"> 351: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;db_name)) {
<span class="line" id="352"> 352: </span>            <span class="php-keyword1">try</span> {
<span class="line" id="353"> 353: </span>                <span class="php-var">$this</span>-&gt;use_database(<span class="php-var">$this</span>-&gt;db_name);
<span class="line" id="354"> 354: </span>            } <span class="php-keyword1">catch</span> (\Throwable <span class="php-var">$ex</span>) {
<span class="line" id="355"> 355: </span>                <span class="php-var">$this</span>-&gt;connection = <span class="php-keyword1">null</span>;
<span class="line" id="356"> 356: </span>                <span class="php-keyword1">throw</span> <span class="php-var">$ex</span>;
<span class="line" id="357"> 357: </span>            }
<span class="line" id="358"> 358: </span>        }
<span class="line" id="359"> 359: </span>    } <span class="php-comment">// connect</span>
<span class="line" id="360"> 360: </span>
<span class="line" id="361"> 361: </span>    <span class="php-comment">/**
</span><span class="line" id="362"> 362: </span><span class="php-comment">     * Sets the database as working database.
</span><span class="line" id="363"> 363: </span><span class="php-comment">     *
</span><span class="line" id="364"> 364: </span><span class="php-comment">     * @param string $db_name
</span><span class="line" id="365"> 365: </span><span class="php-comment">     * The name of the database to be set as working database.
</span><span class="line" id="366"> 366: </span><span class="php-comment">     *
</span><span class="line" id="367"> 367: </span><span class="php-comment">     * @return void
</span><span class="line" id="368"> 368: </span><span class="php-comment">     *
</span><span class="line" id="369"> 369: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="370"> 370: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="371"> 371: </span><span class="php-comment">     *
</span><span class="line" id="372"> 372: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="373"> 373: </span><span class="php-comment">     */</span>
<span class="line" id="374"> 374: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> use_database(<span class="php-var">$db_name</span>)
<span class="line" id="375"> 375: </span>    {
<span class="line" id="376"> 376: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="377"> 377: </span>
<span class="line" id="378"> 378: </span>        <span class="php-var">$this</span>-&gt;db_name = <span class="php-var">$db_name</span>;
<span class="line" id="379"> 379: </span>
<span class="line" id="380"> 380: </span>        <span class="php-var">$db_name</span> = <span class="php-var">$this</span>-&gt;escape(<span class="php-var">$db_name</span>);
<span class="line" id="381"> 381: </span>
<span class="line" id="382"> 382: </span>        <span class="php-var">$this</span>-&gt;execute_query(<span class="php-quote">&quot;USE &quot;</span> . <span class="php-var">$db_name</span>);
<span class="line" id="383"> 383: </span>    } <span class="php-comment">// use_database</span>
<span class="line" id="384"> 384: </span>
<span class="line" id="385"> 385: </span>    <span class="php-comment">/**
</span><span class="line" id="386"> 386: </span><span class="php-comment">     * Returns the name of the database schema if applicable.
</span><span class="line" id="387"> 387: </span><span class="php-comment">     *
</span><span class="line" id="388"> 388: </span><span class="php-comment">     * @return string
</span><span class="line" id="389"> 389: </span><span class="php-comment">     * Returns the name of the database schema if applicable, or an empty string.
</span><span class="line" id="390"> 390: </span><span class="php-comment">     *
</span><span class="line" id="391"> 391: </span><span class="php-comment">     * @see MSSQL_DBWorker::qualify_name_with_schema()
</span><span class="line" id="392"> 392: </span><span class="php-comment">     *
</span><span class="line" id="393"> 393: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="394"> 394: </span><span class="php-comment">     */</span>
<span class="line" id="395"> 395: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> get_schema()
<span class="line" id="396"> 396: </span>    {
<span class="line" id="397"> 397: </span>        <span class="php-keyword1">return</span> <span class="php-quote">&quot;dbo&quot;</span>;
<span class="line" id="398"> 398: </span>    } <span class="php-comment">// get_schema</span>
<span class="line" id="399"> 399: </span>
<span class="line" id="400"> 400: </span>    <span class="php-comment">/**
</span><span class="line" id="401"> 401: </span><span class="php-comment">     * Completes the name of a database object with the schema name if applicable.
</span><span class="line" id="402"> 402: </span><span class="php-comment">     *
</span><span class="line" id="403"> 403: </span><span class="php-comment">     * @param string $name
</span><span class="line" id="404"> 404: </span><span class="php-comment">     * The name of the database object to be completed with the schema name.
</span><span class="line" id="405"> 405: </span><span class="php-comment">     *
</span><span class="line" id="406"> 406: </span><span class="php-comment">     * @return string
</span><span class="line" id="407"> 407: </span><span class="php-comment">     * Returns the name of the database object with the schema name if applicable,
</span><span class="line" id="408"> 408: </span><span class="php-comment">     * otherwise the name of the database object remains unchanged.
</span><span class="line" id="409"> 409: </span><span class="php-comment">     *
</span><span class="line" id="410"> 410: </span><span class="php-comment">     * @see MSSQL_DBWorker::get_schema()
</span><span class="line" id="411"> 411: </span><span class="php-comment">     *
</span><span class="line" id="412"> 412: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="413"> 413: </span><span class="php-comment">     */</span>
<span class="line" id="414"> 414: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> qualify_name_with_schema(<span class="php-var">$name</span>)
<span class="line" id="415"> 415: </span>    {
<span class="line" id="416"> 416: </span>        <span class="php-var">$schema</span> = <span class="php-var">$this</span>-&gt;get_schema();
<span class="line" id="417"> 417: </span>
<span class="line" id="418"> 418: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$schema</span>)) {
<span class="line" id="419"> 419: </span>            <span class="php-var">$schema</span> .= <span class="php-quote">&quot;.&quot;</span>;
<span class="line" id="420"> 420: </span>        }
<span class="line" id="421"> 421: </span>
<span class="line" id="422"> 422: </span>        <span class="php-keyword1">return</span> <span class="php-var">$schema</span> . <span class="php-var">$name</span>;
<span class="line" id="423"> 423: </span>    } <span class="php-comment">// qualify_name_with_schema</span>
<span class="line" id="424"> 424: </span>
<span class="line" id="425"> 425: </span>    <span class="php-comment">/**
</span><span class="line" id="426"> 426: </span><span class="php-comment">     * Executes the SQL query.
</span><span class="line" id="427"> 427: </span><span class="php-comment">     *
</span><span class="line" id="428"> 428: </span><span class="php-comment">     * @param string $query_string
</span><span class="line" id="429"> 429: </span><span class="php-comment">     * The SQL query to be executed.
</span><span class="line" id="430"> 430: </span><span class="php-comment">     *
</span><span class="line" id="431"> 431: </span><span class="php-comment">     * @return void
</span><span class="line" id="432"> 432: </span><span class="php-comment">     *
</span><span class="line" id="433"> 433: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="434"> 434: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="435"> 435: </span><span class="php-comment">     *
</span><span class="line" id="436"> 436: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="437"> 437: </span><span class="php-comment">     */</span>
<span class="line" id="438"> 438: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> execute_query(<span class="php-var">$query_string</span>)
<span class="line" id="439"> 439: </span>    {
<span class="line" id="440"> 440: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="441"> 441: </span>
<span class="line" id="442"> 442: </span>        <span class="php-var">$this</span>-&gt;last_query = <span class="php-var">$query_string</span>;
<span class="line" id="443"> 443: </span>
<span class="line" id="444"> 444: </span>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;logging) {
<span class="line" id="445"> 445: </span>            debugger()-&gt;debugMessage(<span class="php-var">$this</span>-&gt;last_query, <span class="php-quote">&quot;sql.log&quot;</span>);
<span class="line" id="446"> 446: </span>        }
<span class="line" id="447"> 447: </span>
<span class="line" id="448"> 448: </span>        <span class="php-var">$options</span> = [];
<span class="line" id="449"> 449: </span>
<span class="line" id="450"> 450: </span>        <span class="php-comment">/*
</span><span class="line" id="451"> 451: </span><span class="php-comment">        If the cursor is SQLSRV_CURSOR_STATIC or other than
</span><span class="line" id="452"> 452: </span><span class="php-comment">        SQLSRV_CURSOR_FORWARD, retreiving of the data
</span><span class="line" id="453"> 453: </span><span class="php-comment">        has sometimes very poor performance. Not the query execution,
</span><span class="line" id="454"> 454: </span><span class="php-comment">        but the data retrieving!
</span><span class="line" id="455"> 455: </span><span class="php-comment">    
</span><span class="line" id="456"> 456: </span><span class="php-comment">        The default is SQLSRV_CURSOR_FORWARD, but it is not possible
</span><span class="line" id="457"> 457: </span><span class="php-comment">        to get fetched_count by this type of cursor. So we sacrifice
</span><span class="line" id="458"> 458: </span><span class="php-comment">        the possibility to get fetched_count for the preformance.
</span><span class="line" id="459"> 459: </span><span class="php-comment">        The preformance is more important.
</span><span class="line" id="460"> 460: </span><span class="php-comment">    
</span><span class="line" id="461"> 461: </span><span class="php-comment">        no more relevant in new version of driver
</span><span class="line" id="462"> 462: </span><span class="php-comment">        */</span>
<span class="line" id="463"> 463: </span>
<span class="line" id="464"> 464: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword2">preg_match</span>(<span class="php-quote">&quot;/\s*SELECT/i&quot;</span>, <span class="php-var">$query_string</span>)) {
<span class="line" id="465"> 465: </span>            <span class="php-var">$options</span> = [<span class="php-quote">&quot;Scrollable&quot;</span> =&gt; SQLSRV_CURSOR_STATIC];
<span class="line" id="466"> 466: </span>        }
<span class="line" id="467"> 467: </span>
<span class="line" id="468"> 468: </span>        <span class="php-var">$this</span>-&gt;statement = @sqlsrv_query(<span class="php-var">$this</span>-&gt;connection, <span class="php-var">$query_string</span>, [], <span class="php-var">$options</span>);
<span class="line" id="469"> 469: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;statement) {
<span class="line" id="470"> 470: </span>            <span class="php-var">$err</span> = <span class="php-var">$this</span>-&gt;sys_get_errors();
<span class="line" id="471"> 471: </span>
<span class="line" id="472"> 472: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED, <span class="php-quote">&quot;&quot;</span>, [], <span class="php-var">$this</span>-&gt;get_last_query());
<span class="line" id="473"> 473: </span>        }
<span class="line" id="474"> 474: </span>    } <span class="php-comment">// execute_query</span>
<span class="line" id="475"> 475: </span>
<span class="line" id="476"> 476: </span>    <span class="php-comment">/**
</span><span class="line" id="477"> 477: </span><span class="php-comment">     * Prepares the SQL query with bindable variables.
</span><span class="line" id="478"> 478: </span><span class="php-comment">     *
</span><span class="line" id="479"> 479: </span><span class="php-comment">     * @param string $query_string
</span><span class="line" id="480"> 480: </span><span class="php-comment">     * The SQL query to be prepared.
</span><span class="line" id="481"> 481: </span><span class="php-comment">     *
</span><span class="line" id="482"> 482: </span><span class="php-comment">     * @return void
</span><span class="line" id="483"> 483: </span><span class="php-comment">     *
</span><span class="line" id="484"> 484: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="485"> 485: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="486"> 486: </span><span class="php-comment">     *
</span><span class="line" id="487"> 487: </span><span class="php-comment">     * @see MSSQL_DBWorker::execute_prepared_query()
</span><span class="line" id="488"> 488: </span><span class="php-comment">     * @see MSSQL_DBWorker::free_prepared_query()
</span><span class="line" id="489"> 489: </span><span class="php-comment">     *
</span><span class="line" id="490"> 490: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="491"> 491: </span><span class="php-comment">     */</span>
<span class="line" id="492"> 492: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> prepare_query(<span class="php-var">$query_string</span>)
<span class="line" id="493"> 493: </span>    {
<span class="line" id="494"> 494: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="495"> 495: </span>
<span class="line" id="496"> 496: </span>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;statement) {
<span class="line" id="497"> 497: </span>            <span class="php-keyword1">if</span> (<span class="php-keyword2">is_resource</span>(<span class="php-var">$this</span>-&gt;statement)) {
<span class="line" id="498"> 498: </span>                @sqlsrv_free_stmt(<span class="php-var">$this</span>-&gt;statement);
<span class="line" id="499"> 499: </span>            }
<span class="line" id="500"> 500: </span>        }
<span class="line" id="501"> 501: </span>
<span class="line" id="502"> 502: </span>        <span class="php-var">$this</span>-&gt;last_query = <span class="php-var">$query_string</span>;
<span class="line" id="503"> 503: </span>        <span class="php-var">$this</span>-&gt;prepared_query = <span class="php-var">$query_string</span>;
<span class="line" id="504"> 504: </span>
<span class="line" id="505"> 505: </span>        <span class="php-var">$params</span> = [];
<span class="line" id="506"> 506: </span>        <span class="php-var">$this</span>-&gt;query_parameters = [];
<span class="line" id="507"> 507: </span>
<span class="line" id="508"> 508: </span>        <span class="php-var">$cnt</span> = <span class="php-keyword2">preg_match_all</span>(<span class="php-quote">&quot;/\\?/&quot;</span>, <span class="php-var">$query_string</span>, <span class="php-var">$matches</span>);
<span class="line" id="509"> 509: </span>
<span class="line" id="510"> 510: </span>        <span class="php-keyword1">for</span> (<span class="php-var">$i</span> = <span class="php-num">0</span>; <span class="php-var">$i</span> &lt; <span class="php-var">$cnt</span>; <span class="php-var">$i</span>++) {
<span class="line" id="511"> 511: </span>            <span class="php-var">$this</span>-&gt;query_parameters[<span class="php-var">$i</span>] = <span class="php-keyword1">null</span>;
<span class="line" id="512"> 512: </span>            <span class="php-var">$params</span>[<span class="php-var">$i</span>] = &amp;<span class="php-var">$this</span>-&gt;query_parameters[<span class="php-var">$i</span>];
<span class="line" id="513"> 513: </span>        }
<span class="line" id="514"> 514: </span>
<span class="line" id="515"> 515: </span>        <span class="php-var">$query_appendix</span> = <span class="php-quote">&quot;&quot;</span>;
<span class="line" id="516"> 516: </span>
<span class="line" id="517"> 517: </span>        <span class="php-comment">// to be able to get the insert id from prepared query</span>
<span class="line" id="518"> 518: </span>        <span class="php-comment">// we have to add this appendix</span>
<span class="line" id="519"> 519: </span>
<span class="line" id="520"> 520: </span>        <span class="php-var">$this</span>-&gt;last_query_is_insert = <span class="php-keyword1">false</span>;
<span class="line" id="521"> 521: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword2">preg_match</span>(<span class="php-quote">&quot;/\s*INSERT/i&quot;</span>, <span class="php-var">$query_string</span>)) {
<span class="line" id="522"> 522: </span>            <span class="php-var">$this</span>-&gt;last_query_is_insert = <span class="php-keyword1">true</span>;
<span class="line" id="523"> 523: </span>
<span class="line" id="524"> 524: </span>            <span class="php-var">$query_appendix</span> = <span class="php-quote">&quot;; SELECT SCOPE_IDENTITY() AS IID&quot;</span>;
<span class="line" id="525"> 525: </span>        }
<span class="line" id="526"> 526: </span>
<span class="line" id="527"> 527: </span>        <span class="php-var">$options</span> = [];
<span class="line" id="528"> 528: </span>        <span class="php-comment">/*
</span><span class="line" id="529"> 529: </span><span class="php-comment">        If the cursor is SQLSRV_CURSOR_STATIC or other than
</span><span class="line" id="530"> 530: </span><span class="php-comment">        SQLSRV_CURSOR_FORWARD, retreiving of the data
</span><span class="line" id="531"> 531: </span><span class="php-comment">        has sometimes very poor performance. Not the query execution,
</span><span class="line" id="532"> 532: </span><span class="php-comment">        but the data retrieving!
</span><span class="line" id="533"> 533: </span><span class="php-comment">    
</span><span class="line" id="534"> 534: </span><span class="php-comment">        The default is SQLSRV_CURSOR_FORWARD, but it is not possible
</span><span class="line" id="535"> 535: </span><span class="php-comment">        to get fetched_count by this type of cursor. So we sacrifice
</span><span class="line" id="536"> 536: </span><span class="php-comment">        the possibility to get fetched_count for the preformance.
</span><span class="line" id="537"> 537: </span><span class="php-comment">        The preformance is more important.
</span><span class="line" id="538"> 538: </span><span class="php-comment">    
</span><span class="line" id="539"> 539: </span><span class="php-comment">        if(preg_match(&quot;/\s*SELECT/i&quot;, $query_string))
</span><span class="line" id="540"> 540: </span><span class="php-comment">        {
</span><span class="line" id="541"> 541: </span><span class="php-comment">          $options = [&quot;Scrollable&quot; =&gt; SQLSRV_CURSOR_STATIC];
</span><span class="line" id="542"> 542: </span><span class="php-comment">        }
</span><span class="line" id="543"> 543: </span><span class="php-comment">        */</span>
<span class="line" id="544"> 544: </span>
<span class="line" id="545"> 545: </span>        <span class="php-var">$this</span>-&gt;statement = @sqlsrv_prepare(<span class="php-var">$this</span>-&gt;connection, <span class="php-var">$query_string</span> . <span class="php-var">$query_appendix</span>, <span class="php-var">$params</span>, <span class="php-var">$options</span>);
<span class="line" id="546"> 546: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;statement) {
<span class="line" id="547"> 547: </span>            <span class="php-var">$err</span> = <span class="php-var">$this</span>-&gt;sys_get_errors();
<span class="line" id="548"> 548: </span>
<span class="line" id="549"> 549: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED, <span class="php-quote">&quot;&quot;</span>, [], <span class="php-var">$this</span>-&gt;get_last_query());
<span class="line" id="550"> 550: </span>        }
<span class="line" id="551"> 551: </span>    } <span class="php-comment">// prepare_query</span>
<span class="line" id="552"> 552: </span>
<span class="line" id="553"> 553: </span>    <span class="php-comment">/**
</span><span class="line" id="554"> 554: </span><span class="php-comment">     * Stores long data from a stream.
</span><span class="line" id="555"> 555: </span><span class="php-comment">     *
</span><span class="line" id="556"> 556: </span><span class="php-comment">     * @param string $query_string
</span><span class="line" id="557"> 557: </span><span class="php-comment">     * The SQL query to be used for stroing the long data.
</span><span class="line" id="558"> 558: </span><span class="php-comment">     *
</span><span class="line" id="559"> 559: </span><span class="php-comment">     * @param resource &amp;$stream
</span><span class="line" id="560"> 560: </span><span class="php-comment">     * The opened valid stream for reding the long data.
</span><span class="line" id="561"> 561: </span><span class="php-comment">     *
</span><span class="line" id="562"> 562: </span><span class="php-comment">     * Example:
</span><span class="line" id="563"> 563: </span><span class="php-comment">     * ```php
</span><span class="line" id="564"> 564: </span><span class="php-comment">     * $stream = fopen(&quot;.../large_binary.jpg&quot;, &quot;rb&quot;);
</span><span class="line" id="565"> 565: </span><span class="php-comment">     *
</span><span class="line" id="566"> 566: </span><span class="php-comment">     * if(!$dbw-&gt;stream_long_data(&quot;UPDATE LARGE_DATA SET BLOB_DATA = ? WHERE ID = 1&quot;, $stream))
</span><span class="line" id="567"> 567: </span><span class="php-comment">     * {
</span><span class="line" id="568"> 568: </span><span class="php-comment">     *   error reporting ...;
</span><span class="line" id="569"> 569: </span><span class="php-comment">     * }
</span><span class="line" id="570"> 570: </span><span class="php-comment">     * ```
</span><span class="line" id="571"> 571: </span><span class="php-comment">     *
</span><span class="line" id="572"> 572: </span><span class="php-comment">     * @return void
</span><span class="line" id="573"> 573: </span><span class="php-comment">     *
</span><span class="line" id="574"> 574: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="575"> 575: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="576"> 576: </span><span class="php-comment">     *
</span><span class="line" id="577"> 577: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="578"> 578: </span><span class="php-comment">     */</span>
<span class="line" id="579"> 579: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> stream_long_data(<span class="php-var">$query_string</span>, &amp;<span class="php-var">$stream</span>)
<span class="line" id="580"> 580: </span>    {
<span class="line" id="581"> 581: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="582"> 582: </span>
<span class="line" id="583"> 583: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">is_resource</span>(<span class="php-var">$stream</span>)) {
<span class="line" id="584"> 584: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-quote">&quot;Stream is invalid!&quot;</span>, DBWorker::ERR_STREAM_ERROR);
<span class="line" id="585"> 585: </span>        }
<span class="line" id="586"> 586: </span>
<span class="line" id="587"> 587: </span>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;statement) {
<span class="line" id="588"> 588: </span>            <span class="php-keyword1">if</span> (<span class="php-keyword2">is_resource</span>(<span class="php-var">$this</span>-&gt;statement)) {
<span class="line" id="589"> 589: </span>                @sqlsrv_free_stmt(<span class="php-var">$this</span>-&gt;statement);
<span class="line" id="590"> 590: </span>            }
<span class="line" id="591"> 591: </span>        }
<span class="line" id="592"> 592: </span>
<span class="line" id="593"> 593: </span>        <span class="php-var">$this</span>-&gt;last_query = <span class="php-var">$query_string</span>;
<span class="line" id="594"> 594: </span>        <span class="php-var">$this</span>-&gt;prepared_query = <span class="php-var">$query_string</span>;
<span class="line" id="595"> 595: </span>
<span class="line" id="596"> 596: </span>        <span class="php-var">$params</span> = <span class="php-keyword1">array</span>(&amp;<span class="php-var">$stream</span>);
<span class="line" id="597"> 597: </span>
<span class="line" id="598"> 598: </span>        <span class="php-var">$options</span> = <span class="php-keyword1">array</span>(<span class="php-quote">&quot;SendStreamParamsAtExec&quot;</span> =&gt; <span class="php-num">0</span>);
<span class="line" id="599"> 599: </span>
<span class="line" id="600"> 600: </span>        <span class="php-var">$this</span>-&gt;statement = @sqlsrv_prepare(<span class="php-var">$this</span>-&gt;connection, <span class="php-var">$query_string</span>, <span class="php-var">$params</span>, <span class="php-var">$options</span>);
<span class="line" id="601"> 601: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;statement) {
<span class="line" id="602"> 602: </span>            <span class="php-keyword2">fclose</span>(<span class="php-var">$stream</span>);
<span class="line" id="603"> 603: </span>
<span class="line" id="604"> 604: </span>            <span class="php-var">$err</span> = <span class="php-var">$this</span>-&gt;sys_get_errors();
<span class="line" id="605"> 605: </span>
<span class="line" id="606"> 606: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED, <span class="php-quote">&quot;&quot;</span>, [], <span class="php-var">$this</span>-&gt;get_last_query());
<span class="line" id="607"> 607: </span>        }
<span class="line" id="608"> 608: </span>
<span class="line" id="609"> 609: </span>        <span class="php-keyword1">if</span> (!@sqlsrv_execute(<span class="php-var">$this</span>-&gt;statement)) {
<span class="line" id="610"> 610: </span>            <span class="php-var">$err</span> = <span class="php-var">$this</span>-&gt;sys_get_errors();
<span class="line" id="611"> 611: </span>
<span class="line" id="612"> 612: </span>            <span class="php-keyword1">if</span> (<span class="php-keyword2">is_resource</span>(<span class="php-var">$this</span>-&gt;statement)) {
<span class="line" id="613"> 613: </span>                @sqlsrv_free_stmt(<span class="php-var">$this</span>-&gt;statement);
<span class="line" id="614"> 614: </span>            }
<span class="line" id="615"> 615: </span>            <span class="php-var">$this</span>-&gt;statement = <span class="php-keyword1">null</span>;
<span class="line" id="616"> 616: </span>            <span class="php-keyword2">fclose</span>(<span class="php-var">$stream</span>);
<span class="line" id="617"> 617: </span>
<span class="line" id="618"> 618: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED, <span class="php-quote">&quot;&quot;</span>, [], <span class="php-var">$this</span>-&gt;get_last_query());
<span class="line" id="619"> 619: </span>        }
<span class="line" id="620"> 620: </span>
<span class="line" id="621"> 621: </span>        <span class="php-comment">// Send up to 8K of parameter data to the server</span>
<span class="line" id="622"> 622: </span>        <span class="php-comment">// with each call to sqlsrv_send_stream_data.</span>
<span class="line" id="623"> 623: </span>        <span class="php-keyword1">while</span> (sqlsrv_send_stream_data(<span class="php-var">$this</span>-&gt;statement)) {
<span class="line" id="624"> 624: </span>            <span class="php-keyword1">null</span>;
<span class="line" id="625"> 625: </span>        }
<span class="line" id="626"> 626: </span>
<span class="line" id="627"> 627: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword2">is_resource</span>(<span class="php-var">$this</span>-&gt;statement)) {
<span class="line" id="628"> 628: </span>            @sqlsrv_free_stmt(<span class="php-var">$this</span>-&gt;statement);
<span class="line" id="629"> 629: </span>        }
<span class="line" id="630"> 630: </span>        <span class="php-var">$this</span>-&gt;statement = <span class="php-keyword1">null</span>;
<span class="line" id="631"> 631: </span>        <span class="php-keyword2">fclose</span>(<span class="php-var">$stream</span>);
<span class="line" id="632"> 632: </span>    } <span class="php-comment">// stream_long_data</span>
<span class="line" id="633"> 633: </span>
<span class="line" id="634"> 634: </span>    <span class="php-comment">/**
</span><span class="line" id="635"> 635: </span><span class="php-comment">     * Executes the prepared SQL query.
</span><span class="line" id="636"> 636: </span><span class="php-comment">     *
</span><span class="line" id="637"> 637: </span><span class="php-comment">     * @param mixed ...$args
</span><span class="line" id="638"> 638: </span><span class="php-comment">     * The number of parameters may vary and be zero. An array can also be passed.
</span><span class="line" id="639"> 639: </span><span class="php-comment">     * These are paremeters of the prepared query.
</span><span class="line" id="640"> 640: </span><span class="php-comment">     *
</span><span class="line" id="641"> 641: </span><span class="php-comment">     * @return void
</span><span class="line" id="642"> 642: </span><span class="php-comment">     *
</span><span class="line" id="643"> 643: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="644"> 644: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="645"> 645: </span><span class="php-comment">     *
</span><span class="line" id="646"> 646: </span><span class="php-comment">     * @see MSSQL_DBWorker::prepare_query()
</span><span class="line" id="647"> 647: </span><span class="php-comment">     * @see MSSQL_DBWorker::free_prepared_query()
</span><span class="line" id="648"> 648: </span><span class="php-comment">     *
</span><span class="line" id="649"> 649: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="650"> 650: </span><span class="php-comment">     */</span>
<span class="line" id="651"> 651: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> execute_prepared_query(...<span class="php-var">$args</span>)
<span class="line" id="652"> 652: </span>    {
<span class="line" id="653"> 653: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="654"> 654: </span>
<span class="line" id="655"> 655: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;prepared_query) || <span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;statement)) {
<span class="line" id="656"> 656: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-quote">&quot;No prepared query defined&quot;</span>, DBWorker::ERR_QUERY_FAILED);
<span class="line" id="657"> 657: </span>        }
<span class="line" id="658"> 658: </span>
<span class="line" id="659"> 659: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$args</span>) == <span class="php-num">1</span> &amp;&amp; <span class="php-keyword2">is_array</span>(<span class="php-var">$args</span>[<span class="php-num">0</span>])) {
<span class="line" id="660"> 660: </span>            <span class="php-var">$args</span> = <span class="php-var">$args</span>[<span class="php-num">0</span>];
<span class="line" id="661"> 661: </span>        }
<span class="line" id="662"> 662: </span>
<span class="line" id="663"> 663: </span>        <span class="php-var">$this</span>-&gt;last_query = <span class="php-var">$this</span>-&gt;prepared_query;
<span class="line" id="664"> 664: </span>
<span class="line" id="665"> 665: </span>        <span class="php-var">$counter</span> = <span class="php-num">0</span>;
<span class="line" id="666"> 666: </span>        <span class="php-keyword1">foreach</span> (<span class="php-var">$args</span> <span class="php-keyword1">as</span> <span class="php-var">$argval</span>) {
<span class="line" id="667"> 667: </span>            <span class="php-keyword1">if</span> (<span class="php-var">$argval</span> === <span class="php-keyword1">null</span>) {
<span class="line" id="668"> 668: </span>                <span class="php-var">$this</span>-&gt;query_parameters[<span class="php-var">$counter</span>] = <span class="php-var">$argval</span>;
<span class="line" id="669"> 669: </span>
<span class="line" id="670"> 670: </span>                <span class="php-var">$this</span>-&gt;last_query = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">&quot;/\\?/&quot;</span>, <span class="php-quote">&quot;null&quot;</span>, <span class="php-var">$this</span>-&gt;last_query, <span class="php-num">1</span>);
<span class="line" id="671"> 671: </span>            } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">is_int</span>(<span class="php-var">$argval</span>)) {
<span class="line" id="672"> 672: </span>                <span class="php-var">$this</span>-&gt;query_parameters[<span class="php-var">$counter</span>] = <span class="php-var">$argval</span>;
<span class="line" id="673"> 673: </span>
<span class="line" id="674"> 674: </span>                <span class="php-var">$this</span>-&gt;last_query = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">&quot;/\\?/&quot;</span>, <span class="php-var">$argval</span>, <span class="php-var">$this</span>-&gt;last_query, <span class="php-num">1</span>);
<span class="line" id="675"> 675: </span>            } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">is_float</span>(<span class="php-var">$argval</span>)) {
<span class="line" id="676"> 676: </span>                <span class="php-var">$this</span>-&gt;query_parameters[<span class="php-var">$counter</span>] = <span class="php-var">$argval</span>;
<span class="line" id="677"> 677: </span>
<span class="line" id="678"> 678: </span>                <span class="php-var">$this</span>-&gt;last_query = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">&quot;/\\?/&quot;</span>, <span class="php-var">$argval</span>, <span class="php-var">$this</span>-&gt;last_query, <span class="php-num">1</span>);
<span class="line" id="679"> 679: </span>            } <span class="php-keyword1">else</span> {
<span class="line" id="680"> 680: </span>                <span class="php-var">$this</span>-&gt;query_parameters[<span class="php-var">$counter</span>] = <span class="php-var">$argval</span>;
<span class="line" id="681"> 681: </span>
<span class="line" id="682"> 682: </span>                <span class="php-var">$this</span>-&gt;last_query = <span class="php-keyword2">preg_replace</span>(<span class="php-quote">&quot;/\\?/&quot;</span>, \SmartFactory\preg_r_escape(<span class="php-quote">&quot;'&quot;</span> . <span class="php-var">$this</span>-&gt;escape(<span class="php-var">$argval</span>) . <span class="php-quote">&quot;'&quot;</span>), <span class="php-var">$this</span>-&gt;last_query, <span class="php-num">1</span>);
<span class="line" id="683"> 683: </span>            }
<span class="line" id="684"> 684: </span>
<span class="line" id="685"> 685: </span>            <span class="php-var">$counter</span>++;
<span class="line" id="686"> 686: </span>        }
<span class="line" id="687"> 687: </span>
<span class="line" id="688"> 688: </span>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;logging) {
<span class="line" id="689"> 689: </span>            debugger()-&gt;debugMessage(<span class="php-var">$this</span>-&gt;last_query, <span class="php-quote">&quot;sql.log&quot;</span>);
<span class="line" id="690"> 690: </span>        }
<span class="line" id="691"> 691: </span>
<span class="line" id="692"> 692: </span>        <span class="php-keyword1">if</span> (!@sqlsrv_execute(<span class="php-var">$this</span>-&gt;statement)) {
<span class="line" id="693"> 693: </span>            <span class="php-var">$err</span> = <span class="php-var">$this</span>-&gt;sys_get_errors();
<span class="line" id="694"> 694: </span>
<span class="line" id="695"> 695: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED, <span class="php-quote">&quot;&quot;</span>, [], <span class="php-var">$this</span>-&gt;get_last_query());
<span class="line" id="696"> 696: </span>        }
<span class="line" id="697"> 697: </span>    } <span class="php-comment">// execute_prepared_query</span>
<span class="line" id="698"> 698: </span>
<span class="line" id="699"> 699: </span>    <span class="php-comment">/**
</span><span class="line" id="700"> 700: </span><span class="php-comment">     * Executes the SQL stored procedure.
</span><span class="line" id="701"> 701: </span><span class="php-comment">     *
</span><span class="line" id="702"> 702: </span><span class="php-comment">     * @param string $procedure
</span><span class="line" id="703"> 703: </span><span class="php-comment">     * The name of the SQL stored procedure.
</span><span class="line" id="704"> 704: </span><span class="php-comment">     *
</span><span class="line" id="705"> 705: </span><span class="php-comment">     * All subsequent parameters are the paramteres of the SQL stored procedure.
</span><span class="line" id="706"> 706: </span><span class="php-comment">     *
</span><span class="line" id="707"> 707: </span><span class="php-comment">     * @return void
</span><span class="line" id="708"> 708: </span><span class="php-comment">     *
</span><span class="line" id="709"> 709: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="710"> 710: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="711"> 711: </span><span class="php-comment">     *
</span><span class="line" id="712"> 712: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="713"> 713: </span><span class="php-comment">     */</span>
<span class="line" id="714"> 714: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> execute_procedure(<span class="php-var">$procedure</span> <span class="php-comment">/* arg list */</span>)
<span class="line" id="715"> 715: </span>    {
<span class="line" id="716"> 716: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="717"> 717: </span>
<span class="line" id="718"> 718: </span>        <span class="php-var">$args</span> = <span class="php-keyword2">func_get_args</span>();
<span class="line" id="719"> 719: </span>        <span class="php-comment">// prepare the arguments for placing in eval()</span>
<span class="line" id="720"> 720: </span>        <span class="php-comment">// escape single quotes</span>
<span class="line" id="721"> 721: </span>
<span class="line" id="722"> 722: </span>        <span class="php-var">$this</span>-&gt;last_query = <span class="php-quote">&quot;&quot;</span>;
<span class="line" id="723"> 723: </span>
<span class="line" id="724"> 724: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword2">count</span>(<span class="php-var">$args</span>) &gt; <span class="php-num">0</span>) {
<span class="line" id="725"> 725: </span>            <span class="php-var">$proc_name</span> = <span class="php-quote">&quot;&quot;</span>;
<span class="line" id="726"> 726: </span>            <span class="php-var">$arg_list</span> = <span class="php-quote">&quot;&quot;</span>;
<span class="line" id="727"> 727: </span>
<span class="line" id="728"> 728: </span>            <span class="php-var">$first</span> = <span class="php-keyword1">true</span>;
<span class="line" id="729"> 729: </span>            <span class="php-keyword1">foreach</span> (<span class="php-var">$args</span> <span class="php-keyword1">as</span> <span class="php-var">$argkey</span> =&gt; <span class="php-var">$argval</span>) {
<span class="line" id="730"> 730: </span>                <span class="php-keyword1">if</span> (<span class="php-var">$first</span>) {
<span class="line" id="731"> 731: </span>                    <span class="php-var">$proc_name</span> = <span class="php-var">$argval</span>;
<span class="line" id="732"> 732: </span>                    <span class="php-var">$first</span> = <span class="php-keyword1">false</span>;
<span class="line" id="733"> 733: </span>                    <span class="php-keyword1">continue</span>;
<span class="line" id="734"> 734: </span>                }
<span class="line" id="735"> 735: </span>
<span class="line" id="736"> 736: </span>                <span class="php-keyword1">if</span> (<span class="php-var">$argval</span> === <span class="php-keyword1">null</span>) {
<span class="line" id="737"> 737: </span>                    <span class="php-var">$arg_list</span> .= <span class="php-quote">&quot;null, &quot;</span>;
<span class="line" id="738"> 738: </span>                } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">is_int</span>(<span class="php-var">$argval</span>)) {
<span class="line" id="739"> 739: </span>                    <span class="php-var">$arg_list</span> .= <span class="php-quote">&quot;</span><span class="php-var">$argval</span><span class="php-quote">, &quot;</span>;
<span class="line" id="740"> 740: </span>                } <span class="php-keyword1">elseif</span> (<span class="php-keyword2">is_float</span>(<span class="php-var">$argval</span>)) {
<span class="line" id="741"> 741: </span>                    <span class="php-var">$arg_list</span> .= <span class="php-quote">&quot;</span><span class="php-var">$argval</span><span class="php-quote">, &quot;</span>;
<span class="line" id="742"> 742: </span>                } <span class="php-keyword1">else</span> {
<span class="line" id="743"> 743: </span>                    <span class="php-var">$arg_list</span> .= <span class="php-quote">&quot;'&quot;</span> . <span class="php-var">$this</span>-&gt;escape(<span class="php-var">$argval</span>) . <span class="php-quote">&quot;', &quot;</span>;
<span class="line" id="744"> 744: </span>                }
<span class="line" id="745"> 745: </span>            }
<span class="line" id="746"> 746: </span>
<span class="line" id="747"> 747: </span>            <span class="php-var">$arg_list</span> = <span class="php-keyword2">trim</span>(<span class="php-var">$arg_list</span>, <span class="php-quote">&quot;, &quot;</span>);
<span class="line" id="748"> 748: </span>
<span class="line" id="749"> 749: </span>            <span class="php-var">$this</span>-&gt;last_query = <span class="php-keyword2">trim</span>(<span class="php-quote">&quot;EXEC </span><span class="php-var">{$proc_name}</span><span class="php-quote"> </span><span class="php-var">{$arg_list}</span><span class="php-quote">&quot;</span>);
<span class="line" id="750"> 750: </span>        }
<span class="line" id="751"> 751: </span>
<span class="line" id="752"> 752: </span>        <span class="php-var">$this</span>-&gt;execute_query(<span class="php-var">$this</span>-&gt;last_query);
<span class="line" id="753"> 753: </span>
<span class="line" id="754"> 754: </span>        <span class="php-comment">// A stored procedure may generate many result objects.</span>
<span class="line" id="755"> 755: </span>        <span class="php-comment">// We clear them, to prevent errors by subsequent select requests.</span>
<span class="line" id="756"> 756: </span>
<span class="line" id="757"> 757: </span>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;statement &amp;&amp; <span class="php-keyword2">is_resource</span>(<span class="php-var">$this</span>-&gt;statement)) {
<span class="line" id="758"> 758: </span>            @sqlsrv_cancel(<span class="php-var">$this</span>-&gt;statement);
<span class="line" id="759"> 759: </span>        }
<span class="line" id="760"> 760: </span>    } <span class="php-comment">// execute_procedure</span>
<span class="line" id="761"> 761: </span>
<span class="line" id="762"> 762: </span>    <span class="php-comment">/**
</span><span class="line" id="763"> 763: </span><span class="php-comment">     * Frees the prepared query.
</span><span class="line" id="764"> 764: </span><span class="php-comment">     *
</span><span class="line" id="765"> 765: </span><span class="php-comment">     * It should be called after all executions of the prepared query.
</span><span class="line" id="766"> 766: </span><span class="php-comment">     *
</span><span class="line" id="767"> 767: </span><span class="php-comment">     * @return void
</span><span class="line" id="768"> 768: </span><span class="php-comment">     *
</span><span class="line" id="769"> 769: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="770"> 770: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="771"> 771: </span><span class="php-comment">     *
</span><span class="line" id="772"> 772: </span><span class="php-comment">     * @see MSSQL_DBWorker::prepare_query()
</span><span class="line" id="773"> 773: </span><span class="php-comment">     * @see MSSQL_DBWorker::execute_prepared_query()
</span><span class="line" id="774"> 774: </span><span class="php-comment">     *
</span><span class="line" id="775"> 775: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="776"> 776: </span><span class="php-comment">     */</span>
<span class="line" id="777"> 777: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> free_prepared_query()
<span class="line" id="778"> 778: </span>    {
<span class="line" id="779"> 779: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="780"> 780: </span>
<span class="line" id="781"> 781: </span>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;statement &amp;&amp; <span class="php-keyword2">is_resource</span>(<span class="php-var">$this</span>-&gt;statement)) {
<span class="line" id="782"> 782: </span>            @sqlsrv_free_stmt(<span class="php-var">$this</span>-&gt;statement);
<span class="line" id="783"> 783: </span>        }
<span class="line" id="784"> 784: </span>
<span class="line" id="785"> 785: </span>        <span class="php-var">$this</span>-&gt;statement = <span class="php-keyword1">null</span>;
<span class="line" id="786"> 786: </span>        <span class="php-var">$this</span>-&gt;last_query = <span class="php-keyword1">null</span>;
<span class="line" id="787"> 787: </span>        <span class="php-var">$this</span>-&gt;prepared_query = <span class="php-keyword1">null</span>;
<span class="line" id="788"> 788: </span>        <span class="php-var">$this</span>-&gt;query_parameters = <span class="php-keyword1">null</span>;
<span class="line" id="789"> 789: </span>
<span class="line" id="790"> 790: </span>        <span class="php-var">$this</span>-&gt;last_query_is_insert = <span class="php-keyword1">false</span>;
<span class="line" id="791"> 791: </span>    } <span class="php-comment">// free_prepared_query</span>
<span class="line" id="792"> 792: </span>
<span class="line" id="793"> 793: </span>    <span class="php-comment">/**
</span><span class="line" id="794"> 794: </span><span class="php-comment">     * Closes the currently opened connection.
</span><span class="line" id="795"> 795: </span><span class="php-comment">     *
</span><span class="line" id="796"> 796: </span><span class="php-comment">     * @return void
</span><span class="line" id="797"> 797: </span><span class="php-comment">     *
</span><span class="line" id="798"> 798: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="799"> 799: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="800"> 800: </span><span class="php-comment">     *
</span><span class="line" id="801"> 801: </span><span class="php-comment">     * @see MSSQL_DBWorker::is_connected()
</span><span class="line" id="802"> 802: </span><span class="php-comment">     * @see MSSQL_DBWorker::connect()
</span><span class="line" id="803"> 803: </span><span class="php-comment">     *
</span><span class="line" id="804"> 804: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="805"> 805: </span><span class="php-comment">     */</span>
<span class="line" id="806"> 806: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> close_connection()
<span class="line" id="807"> 807: </span>    {
<span class="line" id="808"> 808: </span>        <span class="php-var">$this</span>-&gt;last_query = <span class="php-keyword1">null</span>;
<span class="line" id="809"> 809: </span>        <span class="php-var">$this</span>-&gt;row = <span class="php-keyword1">null</span>;
<span class="line" id="810"> 810: </span>        <span class="php-var">$this</span>-&gt;field_names = <span class="php-keyword1">null</span>;
<span class="line" id="811"> 811: </span>
<span class="line" id="812"> 812: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword2">is_resource</span>(<span class="php-var">$this</span>-&gt;connection)) {
<span class="line" id="813"> 813: </span>            @sqlsrv_close(<span class="php-var">$this</span>-&gt;connection);
<span class="line" id="814"> 814: </span>        }
<span class="line" id="815"> 815: </span>
<span class="line" id="816"> 816: </span>        <span class="php-var">$this</span>-&gt;statement = <span class="php-keyword1">null</span>;
<span class="line" id="817"> 817: </span>        <span class="php-var">$this</span>-&gt;connection = <span class="php-keyword1">null</span>;
<span class="line" id="818"> 818: </span>        <span class="php-var">$this</span>-&gt;query_parameters = <span class="php-keyword1">null</span>;
<span class="line" id="819"> 819: </span>    } <span class="php-comment">// close_connection</span>
<span class="line" id="820"> 820: </span>
<span class="line" id="821"> 821: </span>    <span class="php-comment">/**
</span><span class="line" id="822"> 822: </span><span class="php-comment">     * Starts the transation.
</span><span class="line" id="823"> 823: </span><span class="php-comment">     *
</span><span class="line" id="824"> 824: </span><span class="php-comment">     * @return void
</span><span class="line" id="825"> 825: </span><span class="php-comment">     *
</span><span class="line" id="826"> 826: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="827"> 827: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="828"> 828: </span><span class="php-comment">     *
</span><span class="line" id="829"> 829: </span><span class="php-comment">     * @see MSSQL_DBWorker::commit_transaction()
</span><span class="line" id="830"> 830: </span><span class="php-comment">     * @see MSSQL_DBWorker::rollback_transaction()
</span><span class="line" id="831"> 831: </span><span class="php-comment">     *
</span><span class="line" id="832"> 832: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="833"> 833: </span><span class="php-comment">     */</span>
<span class="line" id="834"> 834: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> start_transaction()
<span class="line" id="835"> 835: </span>    {
<span class="line" id="836"> 836: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="837"> 837: </span>
<span class="line" id="838"> 838: </span>        <span class="php-keyword1">if</span> (!@sqlsrv_begin_transaction(<span class="php-var">$this</span>-&gt;connection)) {
<span class="line" id="839"> 839: </span>            <span class="php-var">$err</span> = <span class="php-var">$this</span>-&gt;sys_get_errors();
<span class="line" id="840"> 840: </span>
<span class="line" id="841"> 841: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED);
<span class="line" id="842"> 842: </span>        }
<span class="line" id="843"> 843: </span>    } <span class="php-comment">// start_transaction</span>
<span class="line" id="844"> 844: </span>
<span class="line" id="845"> 845: </span>    <span class="php-comment">/**
</span><span class="line" id="846"> 846: </span><span class="php-comment">     * Commits the transation.
</span><span class="line" id="847"> 847: </span><span class="php-comment">     *
</span><span class="line" id="848"> 848: </span><span class="php-comment">     * @return void
</span><span class="line" id="849"> 849: </span><span class="php-comment">     *
</span><span class="line" id="850"> 850: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="851"> 851: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="852"> 852: </span><span class="php-comment">     *
</span><span class="line" id="853"> 853: </span><span class="php-comment">     * @see MSSQL_DBWorker::start_transaction()
</span><span class="line" id="854"> 854: </span><span class="php-comment">     * @see MSSQL_DBWorker::rollback_transaction()
</span><span class="line" id="855"> 855: </span><span class="php-comment">     *
</span><span class="line" id="856"> 856: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="857"> 857: </span><span class="php-comment">     */</span>
<span class="line" id="858"> 858: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> commit_transaction()
<span class="line" id="859"> 859: </span>    {
<span class="line" id="860"> 860: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="861"> 861: </span>
<span class="line" id="862"> 862: </span>        <span class="php-keyword1">if</span> (!@sqlsrv_commit(<span class="php-var">$this</span>-&gt;connection)) {
<span class="line" id="863"> 863: </span>            <span class="php-var">$err</span> = <span class="php-var">$this</span>-&gt;sys_get_errors();
<span class="line" id="864"> 864: </span>
<span class="line" id="865"> 865: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED);
<span class="line" id="866"> 866: </span>        }
<span class="line" id="867"> 867: </span>    } <span class="php-comment">// commit_transaction</span>
<span class="line" id="868"> 868: </span>
<span class="line" id="869"> 869: </span>    <span class="php-comment">/**
</span><span class="line" id="870"> 870: </span><span class="php-comment">     * Rolls back the transation.
</span><span class="line" id="871"> 871: </span><span class="php-comment">     *
</span><span class="line" id="872"> 872: </span><span class="php-comment">     * @return void
</span><span class="line" id="873"> 873: </span><span class="php-comment">     *
</span><span class="line" id="874"> 874: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="875"> 875: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="876"> 876: </span><span class="php-comment">     *
</span><span class="line" id="877"> 877: </span><span class="php-comment">     * @see MSSQL_DBWorker::start_transaction()
</span><span class="line" id="878"> 878: </span><span class="php-comment">     * @see MSSQL_DBWorker::commit_transaction()
</span><span class="line" id="879"> 879: </span><span class="php-comment">     *
</span><span class="line" id="880"> 880: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="881"> 881: </span><span class="php-comment">     */</span>
<span class="line" id="882"> 882: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> rollback_transaction()
<span class="line" id="883"> 883: </span>    {
<span class="line" id="884"> 884: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="885"> 885: </span>
<span class="line" id="886"> 886: </span>        <span class="php-keyword1">if</span> (!@sqlsrv_rollback(<span class="php-var">$this</span>-&gt;connection)) {
<span class="line" id="887"> 887: </span>            <span class="php-var">$err</span> = <span class="php-var">$this</span>-&gt;sys_get_errors();
<span class="line" id="888"> 888: </span>
<span class="line" id="889"> 889: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED);
<span class="line" id="890"> 890: </span>        }
<span class="line" id="891"> 891: </span>    } <span class="php-comment">// rollback_transaction</span>
<span class="line" id="892"> 892: </span>
<span class="line" id="893"> 893: </span>    <span class="php-comment">/**
</span><span class="line" id="894"> 894: </span><span class="php-comment">     * Frees the result of the previously executed retrieving query.
</span><span class="line" id="895"> 895: </span><span class="php-comment">     *
</span><span class="line" id="896"> 896: </span><span class="php-comment">     * It should be called only for the retrieving queries.
</span><span class="line" id="897"> 897: </span><span class="php-comment">     *
</span><span class="line" id="898"> 898: </span><span class="php-comment">     * @return void
</span><span class="line" id="899"> 899: </span><span class="php-comment">     *
</span><span class="line" id="900"> 900: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="901"> 901: </span><span class="php-comment">     */</span>
<span class="line" id="902"> 902: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> free_result()
<span class="line" id="903"> 903: </span>    {
<span class="line" id="904"> 904: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="905"> 905: </span>
<span class="line" id="906"> 906: </span>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;statement &amp;&amp; <span class="php-keyword2">is_resource</span>(<span class="php-var">$this</span>-&gt;statement)) {
<span class="line" id="907"> 907: </span>            @sqlsrv_cancel(<span class="php-var">$this</span>-&gt;statement);
<span class="line" id="908"> 908: </span>        }
<span class="line" id="909"> 909: </span>
<span class="line" id="910"> 910: </span>        <span class="php-var">$this</span>-&gt;row = <span class="php-keyword1">null</span>;
<span class="line" id="911"> 911: </span>        <span class="php-var">$this</span>-&gt;field_names = <span class="php-keyword1">null</span>;
<span class="line" id="912"> 912: </span>    } <span class="php-comment">// free_result</span>
<span class="line" id="913"> 913: </span>
<span class="line" id="914"> 914: </span>    <span class="php-comment">/**
</span><span class="line" id="915"> 915: </span><span class="php-comment">     * Returns the value of the auto increment field by the last insertion.
</span><span class="line" id="916"> 916: </span><span class="php-comment">     *
</span><span class="line" id="917"> 917: </span><span class="php-comment">     * @return int
</span><span class="line" id="918"> 918: </span><span class="php-comment">     * Returns the value of the auto increment field by the last insertion.
</span><span class="line" id="919"> 919: </span><span class="php-comment">     *
</span><span class="line" id="920"> 920: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="921"> 921: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="922"> 922: </span><span class="php-comment">     *
</span><span class="line" id="923"> 923: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="924"> 924: </span><span class="php-comment">     */</span>
<span class="line" id="925"> 925: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> insert_id()
<span class="line" id="926"> 926: </span>    {
<span class="line" id="927"> 927: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="928"> 928: </span>
<span class="line" id="929"> 929: </span>        <span class="php-keyword1">if</span> (<span class="php-var">$this</span>-&gt;last_query_is_insert) {
<span class="line" id="930"> 930: </span>            <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;statement) {
<span class="line" id="931"> 931: </span>                <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
<span class="line" id="932"> 932: </span>            }
<span class="line" id="933"> 933: </span>
<span class="line" id="934"> 934: </span>            <span class="php-keyword1">if</span> (!sqlsrv_next_result(<span class="php-var">$this</span>-&gt;statement)) {
<span class="line" id="935"> 935: </span>                <span class="php-var">$err</span> = <span class="php-var">$this</span>-&gt;sys_get_errors();
<span class="line" id="936"> 936: </span>
<span class="line" id="937"> 937: </span>                <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED);
<span class="line" id="938"> 938: </span>            }
<span class="line" id="939"> 939: </span>
<span class="line" id="940"> 940: </span>            <span class="php-var">$id</span> = <span class="php-keyword1">null</span>;
<span class="line" id="941"> 941: </span>
<span class="line" id="942"> 942: </span>            <span class="php-keyword1">if</span> (@sqlsrv_fetch(<span class="php-var">$this</span>-&gt;statement)) {
<span class="line" id="943"> 943: </span>                <span class="php-var">$id</span> = sqlsrv_get_field(<span class="php-var">$this</span>-&gt;statement, <span class="php-num">0</span>);
<span class="line" id="944"> 944: </span>            }
<span class="line" id="945"> 945: </span>
<span class="line" id="946"> 946: </span>            <span class="php-keyword1">return</span> <span class="php-var">$id</span>;
<span class="line" id="947"> 947: </span>        }
<span class="line" id="948"> 948: </span>
<span class="line" id="949"> 949: </span>        <span class="php-var">$this</span>-&gt;statement = @sqlsrv_query(<span class="php-var">$this</span>-&gt;connection, <span class="php-quote">&quot;SELECT SCOPE_IDENTITY() AS IID&quot;</span>);
<span class="line" id="950"> 950: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;statement) {
<span class="line" id="951"> 951: </span>            <span class="php-var">$err</span> = <span class="php-var">$this</span>-&gt;sys_get_errors();
<span class="line" id="952"> 952: </span>
<span class="line" id="953"> 953: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED);
<span class="line" id="954"> 954: </span>        }
<span class="line" id="955"> 955: </span>
<span class="line" id="956"> 956: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;fetch_row()) {
<span class="line" id="957"> 957: </span>            <span class="php-var">$err</span> = <span class="php-quote">&quot;Identity field cannot be retrieved&quot;</span>;
<span class="line" id="958"> 958: </span>
<span class="line" id="959"> 959: </span>            <span class="php-var">$this</span>-&gt;free_result();
<span class="line" id="960"> 960: </span>
<span class="line" id="961"> 961: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED);
<span class="line" id="962"> 962: </span>        }
<span class="line" id="963"> 963: </span>
<span class="line" id="964"> 964: </span>        <span class="php-var">$id</span> = <span class="php-var">$this</span>-&gt;field_by_name(<span class="php-quote">&quot;IID&quot;</span>);
<span class="line" id="965"> 965: </span>
<span class="line" id="966"> 966: </span>        <span class="php-var">$this</span>-&gt;free_result();
<span class="line" id="967"> 967: </span>
<span class="line" id="968"> 968: </span>        <span class="php-keyword1">return</span> <span class="php-var">$id</span>;
<span class="line" id="969"> 969: </span>    } <span class="php-comment">// insert_id</span>
<span class="line" id="970"> 970: </span>
<span class="line" id="971"> 971: </span>    <span class="php-comment">/**
</span><span class="line" id="972"> 972: </span><span class="php-comment">     * Fetches the next row of data from the result of the execution of the retrieving query.
</span><span class="line" id="973"> 973: </span><span class="php-comment">     *
</span><span class="line" id="974"> 974: </span><span class="php-comment">     * @return boolean
</span><span class="line" id="975"> 975: </span><span class="php-comment">     * Returns true if the next row exists and has been successfully fetched, otherwise false.
</span><span class="line" id="976"> 976: </span><span class="php-comment">     *
</span><span class="line" id="977"> 977: </span><span class="php-comment">     * Example:
</span><span class="line" id="978"> 978: </span><span class="php-comment">     * ```php
</span><span class="line" id="979"> 979: </span><span class="php-comment">     * if(!$dbw-&gt;execute_query(&quot;SELECT FIRST_NAME, LAST_NAME FROM USERS&quot;))
</span><span class="line" id="980"> 980: </span><span class="php-comment">     * {
</span><span class="line" id="981"> 981: </span><span class="php-comment">     *   error reporting ...;
</span><span class="line" id="982"> 982: </span><span class="php-comment">     * }
</span><span class="line" id="983"> 983: </span><span class="php-comment">     *
</span><span class="line" id="984"> 984: </span><span class="php-comment">     * while($dbw-&gt;fetch_row())
</span><span class="line" id="985"> 985: </span><span class="php-comment">     * {
</span><span class="line" id="986"> 986: </span><span class="php-comment">     *   echo $dbw-&gt;field_by_name(&quot;FIRST_NAME&quot;) . &quot; &quot; . $dbw-&gt;field_by_name(&quot;LAST_NAME&quot;) . &quot;&lt;br&gt;&quot;;
</span><span class="line" id="987"> 987: </span><span class="php-comment">     * }
</span><span class="line" id="988"> 988: </span><span class="php-comment">     *
</span><span class="line" id="989"> 989: </span><span class="php-comment">     * $dbw-&gt;free_result();
</span><span class="line" id="990"> 990: </span><span class="php-comment">     * ```
</span><span class="line" id="991"> 991: </span><span class="php-comment">     *
</span><span class="line" id="992"> 992: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="993"> 993: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="994"> 994: </span><span class="php-comment">     *
</span><span class="line" id="995"> 995: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="996"> 996: </span><span class="php-comment">     */</span>
<span class="line" id="997"> 997: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> fetch_row()
<span class="line" id="998"> 998: </span>    {
<span class="line" id="999"> 999: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="1000">1000: </span>
<span class="line" id="1001">1001: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;statement || !<span class="php-keyword2">is_resource</span>(<span class="php-var">$this</span>-&gt;statement)) {
<span class="line" id="1002">1002: </span>            <span class="php-var">$err</span> = <span class="php-quote">&quot;Result fetch error&quot;</span>;
<span class="line" id="1003">1003: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED, <span class="php-quote">&quot;&quot;</span>, [], <span class="php-var">$this</span>-&gt;get_last_query());
<span class="line" id="1004">1004: </span>        }
<span class="line" id="1005">1005: </span>
<span class="line" id="1006">1006: </span>        <span class="php-var">$this</span>-&gt;row = @sqlsrv_fetch_array(<span class="php-var">$this</span>-&gt;statement, SQLSRV_FETCH_ASSOC);
<span class="line" id="1007">1007: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;row) {
<span class="line" id="1008">1008: </span>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<span class="line" id="1009">1009: </span>        }
<span class="line" id="1010">1010: </span>
<span class="line" id="1011">1011: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;field_names) {
<span class="line" id="1012">1012: </span>            <span class="php-var">$this</span>-&gt;field_names = <span class="php-keyword2">array_keys</span>(<span class="php-var">$this</span>-&gt;row);
<span class="line" id="1013">1013: </span>        }
<span class="line" id="1014">1014: </span>
<span class="line" id="1015">1015: </span>        <span class="php-keyword1">return</span> <span class="php-keyword1">true</span>;
<span class="line" id="1016">1016: </span>    } <span class="php-comment">// fetch_row</span>
<span class="line" id="1017">1017: </span>
<span class="line" id="1018">1018: </span>    <span class="php-comment">/**
</span><span class="line" id="1019">1019: </span><span class="php-comment">     * Fetches all rows from the result into an array.
</span><span class="line" id="1020">1020: </span><span class="php-comment">     *
</span><span class="line" id="1021">1021: </span><span class="php-comment">     * @param array &amp;$rows
</span><span class="line" id="1022">1022: </span><span class="php-comment">     * Target array for loading the results.
</span><span class="line" id="1023">1023: </span><span class="php-comment">     *
</span><span class="line" id="1024">1024: </span><span class="php-comment">     * @param array $dimension_keys
</span><span class="line" id="1025">1025: </span><span class="php-comment">     * Array of the column names that should be used as dimensions.
</span><span class="line" id="1026">1026: </span><span class="php-comment">     *
</span><span class="line" id="1027">1027: </span><span class="php-comment">     * Per default, the rows are fetched as two-dimensional array.
</span><span class="line" id="1028">1028: </span><span class="php-comment">     *
</span><span class="line" id="1029">1029: </span><span class="php-comment">     * Example:
</span><span class="line" id="1030">1030: </span><span class="php-comment">     * ```php
</span><span class="line" id="1031">1031: </span><span class="php-comment">     * $rows = [];
</span><span class="line" id="1032">1032: </span><span class="php-comment">     * $dbw-&gt;fetch_array($rows);
</span><span class="line" id="1033">1033: </span><span class="php-comment">     *
</span><span class="line" id="1034">1034: </span><span class="php-comment">     * rows[n] = [&quot;col1&quot; =&gt; &quot;val1&quot;, &quot;col2&quot; =&gt; &quot;val2&quot;, , &quot;col3&quot; =&gt; &quot;val3&quot;, ...]
</span><span class="line" id="1035">1035: </span><span class="php-comment">     * ```
</span><span class="line" id="1036">1036: </span><span class="php-comment">     * If the dimension columns are specified, their values are used for the dimensions.
</span><span class="line" id="1037">1037: </span><span class="php-comment">     *
</span><span class="line" id="1038">1038: </span><span class="php-comment">     * Example:
</span><span class="line" id="1039">1039: </span><span class="php-comment">     * ```php
</span><span class="line" id="1040">1040: </span><span class="php-comment">     * $rows = [];
</span><span class="line" id="1041">1041: </span><span class="php-comment">     * $dbw-&gt;fetch_array($rows, [&quot;col1&quot;, &quot;col2&quot;]);
</span><span class="line" id="1042">1042: </span><span class="php-comment">     *
</span><span class="line" id="1043">1043: </span><span class="php-comment">     * rows[&quot;val1&quot;][&quot;val2&quot;] = [&quot;col3&quot; =&gt; &quot;val3&quot;, ...]
</span><span class="line" id="1044">1044: </span><span class="php-comment">     * ```
</span><span class="line" id="1045">1045: </span><span class="php-comment">     *
</span><span class="line" id="1046">1046: </span><span class="php-comment">     * @return int
</span><span class="line" id="1047">1047: </span><span class="php-comment">     * Returns the number of the fetched rows. It might be also 0.
</span><span class="line" id="1048">1048: </span><span class="php-comment">     *
</span><span class="line" id="1049">1049: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="1050">1050: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="1051">1051: </span><span class="php-comment">     *
</span><span class="line" id="1052">1052: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1053">1053: </span><span class="php-comment">     */</span>
<span class="line" id="1054">1054: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> fetch_array(&amp;<span class="php-var">$rows</span>, <span class="php-var">$dimension_keys</span> = <span class="php-keyword1">null</span>)
<span class="line" id="1055">1055: </span>    {
<span class="line" id="1056">1056: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="1057">1057: </span>
<span class="line" id="1058">1058: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;statement || !<span class="php-keyword2">is_resource</span>(<span class="php-var">$this</span>-&gt;statement)) {
<span class="line" id="1059">1059: </span>            <span class="php-var">$err</span> = <span class="php-quote">&quot;Result fetch error&quot;</span>;
<span class="line" id="1060">1060: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED, <span class="php-quote">&quot;&quot;</span>, [], <span class="php-var">$this</span>-&gt;get_last_query());
<span class="line" id="1061">1061: </span>        }
<span class="line" id="1062">1062: </span>
<span class="line" id="1063">1063: </span>        <span class="php-var">$rows</span> = [];
<span class="line" id="1064">1064: </span>
<span class="line" id="1065">1065: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$dimension_keys</span>)) {
<span class="line" id="1066">1066: </span>            <span class="php-var">$dimension_keys</span> = <span class="php-keyword2">array_flip</span>(<span class="php-var">$dimension_keys</span>);
<span class="line" id="1067">1067: </span>        }
<span class="line" id="1068">1068: </span>
<span class="line" id="1069">1069: </span>        <span class="php-var">$counter</span> = <span class="php-num">0</span>;
<span class="line" id="1070">1070: </span>        <span class="php-keyword1">while</span> (<span class="php-var">$row</span> = @sqlsrv_fetch_array(<span class="php-var">$this</span>-&gt;statement, SQLSRV_FETCH_ASSOC)) {
<span class="line" id="1071">1071: </span>            <span class="php-var">$counter</span>++;
<span class="line" id="1072">1072: </span>
<span class="line" id="1073">1073: </span>            <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;field_names) {
<span class="line" id="1074">1074: </span>                <span class="php-var">$this</span>-&gt;field_names = <span class="php-keyword2">array_keys</span>(<span class="php-var">$row</span>);
<span class="line" id="1075">1075: </span>            }
<span class="line" id="1076">1076: </span>
<span class="line" id="1077">1077: </span>            <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$dimension_keys</span>)) {
<span class="line" id="1078">1078: </span>                <span class="php-var">$rows</span>[] = <span class="php-var">$row</span>;
<span class="line" id="1079">1079: </span>            } <span class="php-keyword1">else</span> {
<span class="line" id="1080">1080: </span>                <span class="php-var">$dimensions</span> = <span class="php-keyword2">array_intersect_key</span>(<span class="php-var">$row</span>, <span class="php-var">$dimension_keys</span>);
<span class="line" id="1081">1081: </span>                <span class="php-var">$row</span> = <span class="php-keyword2">array_diff_key</span>(<span class="php-var">$row</span>, <span class="php-var">$dimension_keys</span>);
<span class="line" id="1082">1082: </span>
<span class="line" id="1083">1083: </span>                <span class="php-var">$reference</span> = &amp;<span class="php-var">$rows</span>;
<span class="line" id="1084">1084: </span>
<span class="line" id="1085">1085: </span>                <span class="php-keyword1">foreach</span> (<span class="php-var">$dimensions</span> <span class="php-keyword1">as</span> &amp;<span class="php-var">$dval</span>) {
<span class="line" id="1086">1086: </span>                    <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$reference</span>[<span class="php-var">$dval</span>])) {
<span class="line" id="1087">1087: </span>                        <span class="php-var">$reference</span>[<span class="php-var">$dval</span>] = [];
<span class="line" id="1088">1088: </span>                    }
<span class="line" id="1089">1089: </span>                    <span class="php-var">$reference</span> = &amp;<span class="php-var">$reference</span>[<span class="php-var">$dval</span>];
<span class="line" id="1090">1090: </span>                }
<span class="line" id="1091">1091: </span>
<span class="line" id="1092">1092: </span>                <span class="php-var">$reference</span> = <span class="php-var">$row</span>;
<span class="line" id="1093">1093: </span>
<span class="line" id="1094">1094: </span>                <span class="php-keyword1">unset</span>(<span class="php-var">$reference</span>);
<span class="line" id="1095">1095: </span>            }
<span class="line" id="1096">1096: </span>        }
<span class="line" id="1097">1097: </span>
<span class="line" id="1098">1098: </span>        <span class="php-keyword1">return</span> <span class="php-var">$counter</span>;
<span class="line" id="1099">1099: </span>    } <span class="php-comment">// fetch_array</span>
<span class="line" id="1100">1100: </span>
<span class="line" id="1101">1101: </span>    <span class="php-comment">/**
</span><span class="line" id="1102">1102: </span><span class="php-comment">     * Returns the number of the rows fetched by the last retrieving query.
</span><span class="line" id="1103">1103: </span><span class="php-comment">     *
</span><span class="line" id="1104">1104: </span><span class="php-comment">     * @return int
</span><span class="line" id="1105">1105: </span><span class="php-comment">     * Returns the number of the rows fetched by the last retrieving query.
</span><span class="line" id="1106">1106: </span><span class="php-comment">     *
</span><span class="line" id="1107">1107: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="1108">1108: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="1109">1109: </span><span class="php-comment">     *
</span><span class="line" id="1110">1110: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1111">1111: </span><span class="php-comment">     */</span>
<span class="line" id="1112">1112: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> fetched_count()
<span class="line" id="1113">1113: </span>    {
<span class="line" id="1114">1114: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="1115">1115: </span>
<span class="line" id="1116">1116: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;statement || !<span class="php-keyword2">is_resource</span>(<span class="php-var">$this</span>-&gt;statement)) {
<span class="line" id="1117">1117: </span>            <span class="php-var">$err</span> = <span class="php-quote">&quot;Result fetch error&quot;</span>;
<span class="line" id="1118">1118: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED, <span class="php-quote">&quot;&quot;</span>, [], <span class="php-var">$this</span>-&gt;get_last_query());
<span class="line" id="1119">1119: </span>        }
<span class="line" id="1120">1120: </span>
<span class="line" id="1121">1121: </span>        <span class="php-comment">/*
</span><span class="line" id="1122">1122: </span><span class="php-comment">        If the cursor is SQLSRV_CURSOR_STATIC or other than
</span><span class="line" id="1123">1123: </span><span class="php-comment">        SQLSRV_CURSOR_FORWARD, retreiving of the data
</span><span class="line" id="1124">1124: </span><span class="php-comment">        has sometimes very poor performance. Not the query execution,
</span><span class="line" id="1125">1125: </span><span class="php-comment">        but the data retrieving!
</span><span class="line" id="1126">1126: </span><span class="php-comment">
</span><span class="line" id="1127">1127: </span><span class="php-comment">        The default is SQLSRV_CURSOR_FORWARD, but it is not possible
</span><span class="line" id="1128">1128: </span><span class="php-comment">        to get fetched_count by this type of cursor. So we sacrifice
</span><span class="line" id="1129">1129: </span><span class="php-comment">        the possibility to get fetched_count for the preformance.
</span><span class="line" id="1130">1130: </span><span class="php-comment">        The preformance is more important.
</span><span class="line" id="1131">1131: </span><span class="php-comment">
</span><span class="line" id="1132">1132: </span><span class="php-comment">        no more relevant in new version of driver
</span><span class="line" id="1133">1133: </span><span class="php-comment">        */</span>
<span class="line" id="1134">1134: </span>
<span class="line" id="1135">1135: </span>        <span class="php-keyword1">return</span> @sqlsrv_num_rows(<span class="php-var">$this</span>-&gt;statement);
<span class="line" id="1136">1136: </span>    } <span class="php-comment">// fetched_count</span>
<span class="line" id="1137">1137: </span>
<span class="line" id="1138">1138: </span>    <span class="php-comment">/**
</span><span class="line" id="1139">1139: </span><span class="php-comment">     * Returns the number of the rows affected by the last modification query.
</span><span class="line" id="1140">1140: </span><span class="php-comment">     *
</span><span class="line" id="1141">1141: </span><span class="php-comment">     * @return int
</span><span class="line" id="1142">1142: </span><span class="php-comment">     * Returns the number of the rows affected by the last modification query.
</span><span class="line" id="1143">1143: </span><span class="php-comment">     *
</span><span class="line" id="1144">1144: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="1145">1145: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="1146">1146: </span><span class="php-comment">     *
</span><span class="line" id="1147">1147: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1148">1148: </span><span class="php-comment">     */</span>
<span class="line" id="1149">1149: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> affected_count()
<span class="line" id="1150">1150: </span>    {
<span class="line" id="1151">1151: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="1152">1152: </span>
<span class="line" id="1153">1153: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;statement) {
<span class="line" id="1154">1154: </span>            <span class="php-var">$err</span> = <span class="php-quote">&quot;Result fetch error&quot;</span>;
<span class="line" id="1155">1155: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED, <span class="php-quote">&quot;&quot;</span>, [], <span class="php-var">$this</span>-&gt;get_last_query());
<span class="line" id="1156">1156: </span>        }
<span class="line" id="1157">1157: </span>
<span class="line" id="1158">1158: </span>        <span class="php-keyword1">return</span> @sqlsrv_rows_affected(<span class="php-var">$this</span>-&gt;statement);
<span class="line" id="1159">1159: </span>    } <span class="php-comment">// affected_count</span>
<span class="line" id="1160">1160: </span>
<span class="line" id="1161">1161: </span>    <span class="php-comment">/**
</span><span class="line" id="1162">1162: </span><span class="php-comment">     * Returns the number of the fields in the result of the last retrieving query.
</span><span class="line" id="1163">1163: </span><span class="php-comment">     *
</span><span class="line" id="1164">1164: </span><span class="php-comment">     * @return int
</span><span class="line" id="1165">1165: </span><span class="php-comment">     * Returns the number of the fields in the result of the last retrieving query.
</span><span class="line" id="1166">1166: </span><span class="php-comment">     *
</span><span class="line" id="1167">1167: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="1168">1168: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="1169">1169: </span><span class="php-comment">     *
</span><span class="line" id="1170">1170: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1171">1171: </span><span class="php-comment">     */</span>
<span class="line" id="1172">1172: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> field_count()
<span class="line" id="1173">1173: </span>    {
<span class="line" id="1174">1174: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="1175">1175: </span>
<span class="line" id="1176">1176: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;statement) {
<span class="line" id="1177">1177: </span>            <span class="php-var">$err</span> = <span class="php-quote">&quot;Result fetch error&quot;</span>;
<span class="line" id="1178">1178: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED, <span class="php-quote">&quot;&quot;</span>, [], <span class="php-var">$this</span>-&gt;get_last_query());
<span class="line" id="1179">1179: </span>        }
<span class="line" id="1180">1180: </span>
<span class="line" id="1181">1181: </span>        <span class="php-keyword1">return</span> @sqlsrv_num_fields(<span class="php-var">$this</span>-&gt;statement);
<span class="line" id="1182">1182: </span>    } <span class="php-comment">// field_count</span>
<span class="line" id="1183">1183: </span>
<span class="line" id="1184">1184: </span>    <span class="php-comment">/**
</span><span class="line" id="1185">1185: </span><span class="php-comment">     * Returns the value of a field specified by name.
</span><span class="line" id="1186">1186: </span><span class="php-comment">     *
</span><span class="line" id="1187">1187: </span><span class="php-comment">     * @param string $name
</span><span class="line" id="1188">1188: </span><span class="php-comment">     * The name of the field.
</span><span class="line" id="1189">1189: </span><span class="php-comment">     *
</span><span class="line" id="1190">1190: </span><span class="php-comment">     * @param int $type
</span><span class="line" id="1191">1191: </span><span class="php-comment">     * The type of the field.
</span><span class="line" id="1192">1192: </span><span class="php-comment">     *
</span><span class="line" id="1193">1193: </span><span class="php-comment">     * @return mixed|null
</span><span class="line" id="1194">1194: </span><span class="php-comment">     * Returns the value of a field specified by name. In the case
</span><span class="line" id="1195">1195: </span><span class="php-comment">     * of any error returns null.
</span><span class="line" id="1196">1196: </span><span class="php-comment">     *
</span><span class="line" id="1197">1197: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="1198">1198: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="1199">1199: </span><span class="php-comment">     *
</span><span class="line" id="1200">1200: </span><span class="php-comment">     * @see MSSQL_DBWorker::field_by_num()
</span><span class="line" id="1201">1201: </span><span class="php-comment">     * @see MSSQL_DBWorker::field_name()
</span><span class="line" id="1202">1202: </span><span class="php-comment">     *
</span><span class="line" id="1203">1203: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1204">1204: </span><span class="php-comment">     */</span>
<span class="line" id="1205">1205: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> field_by_name(<span class="php-var">$name</span>, <span class="php-var">$type</span> = self::DB_AS_IS)
<span class="line" id="1206">1206: </span>    {
<span class="line" id="1207">1207: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="1208">1208: </span>
<span class="line" id="1209">1209: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;row) {
<span class="line" id="1210">1210: </span>            <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
<span class="line" id="1211">1211: </span>        }
<span class="line" id="1212">1212: </span>
<span class="line" id="1213">1213: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">array_key_exists</span>(<span class="php-var">$name</span>, <span class="php-var">$this</span>-&gt;row)) {
<span class="line" id="1214">1214: </span>            <span class="php-keyword2">trigger_error</span>(<span class="php-quote">&quot;Field with the name '</span><span class="php-var">$name</span><span class="php-quote">' does not exist in the result set!&quot;</span>, E_USER_WARNING);
<span class="line" id="1215">1215: </span>            <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
<span class="line" id="1216">1216: </span>        }
<span class="line" id="1217">1217: </span>
<span class="line" id="1218">1218: </span>        <span class="php-keyword1">if</span> ((<span class="php-var">$type</span> == DBWorker::DB_DATE || <span class="php-var">$type</span> == DBWorker::DB_DATETIME) &amp;&amp; !<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;row[<span class="php-var">$name</span>])) {
<span class="line" id="1219">1219: </span>            <span class="php-keyword1">return</span> <span class="php-keyword2">strtotime</span>(<span class="php-var">$this</span>-&gt;row[<span class="php-var">$name</span>]);
<span class="line" id="1220">1220: </span>        }
<span class="line" id="1221">1221: </span>
<span class="line" id="1222">1222: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;row[<span class="php-var">$name</span>];
<span class="line" id="1223">1223: </span>    } <span class="php-comment">// field_by_name</span>
<span class="line" id="1224">1224: </span>
<span class="line" id="1225">1225: </span>    <span class="php-comment">/**
</span><span class="line" id="1226">1226: </span><span class="php-comment">     * Returns the value of a field specified by number.
</span><span class="line" id="1227">1227: </span><span class="php-comment">     *
</span><span class="line" id="1228">1228: </span><span class="php-comment">     * @param int $num
</span><span class="line" id="1229">1229: </span><span class="php-comment">     * The number of the field.
</span><span class="line" id="1230">1230: </span><span class="php-comment">     *
</span><span class="line" id="1231">1231: </span><span class="php-comment">     * @param int $type
</span><span class="line" id="1232">1232: </span><span class="php-comment">     * The type of the field.
</span><span class="line" id="1233">1233: </span><span class="php-comment">     *
</span><span class="line" id="1234">1234: </span><span class="php-comment">     * @return mixed|null
</span><span class="line" id="1235">1235: </span><span class="php-comment">     * Returns the value of a field specified by number. In the case
</span><span class="line" id="1236">1236: </span><span class="php-comment">     * of any error returns null.
</span><span class="line" id="1237">1237: </span><span class="php-comment">     *
</span><span class="line" id="1238">1238: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="1239">1239: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="1240">1240: </span><span class="php-comment">     *
</span><span class="line" id="1241">1241: </span><span class="php-comment">     * @see MSSQL_DBWorker::field_by_name()
</span><span class="line" id="1242">1242: </span><span class="php-comment">     * @see MSSQL_DBWorker::field_info_by_num()
</span><span class="line" id="1243">1243: </span><span class="php-comment">     * @see MSSQL_DBWorker::field_name()
</span><span class="line" id="1244">1244: </span><span class="php-comment">     *
</span><span class="line" id="1245">1245: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1246">1246: </span><span class="php-comment">     */</span>
<span class="line" id="1247">1247: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> field_by_num(<span class="php-var">$num</span>, <span class="php-var">$type</span> = self::DB_AS_IS)
<span class="line" id="1248">1248: </span>    {
<span class="line" id="1249">1249: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="1250">1250: </span>
<span class="line" id="1251">1251: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;row) {
<span class="line" id="1252">1252: </span>            <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
<span class="line" id="1253">1253: </span>        }
<span class="line" id="1254">1254: </span>
<span class="line" id="1255">1255: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword2">array_key_exists</span>(<span class="php-var">$num</span>, <span class="php-var">$this</span>-&gt;field_names)) {
<span class="line" id="1256">1256: </span>            <span class="php-keyword2">trigger_error</span>(<span class="php-quote">&quot;Field with the index </span><span class="php-var">$num</span><span class="php-quote"> does not exist in the result set!&quot;</span>, E_USER_WARNING);
<span class="line" id="1257">1257: </span>            <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
<span class="line" id="1258">1258: </span>        }
<span class="line" id="1259">1259: </span>
<span class="line" id="1260">1260: </span>        <span class="php-keyword1">if</span> ((<span class="php-var">$type</span> == DBWorker::DB_DATE || <span class="php-var">$type</span> == DBWorker::DB_DATETIME) &amp;&amp; !<span class="php-keyword1">empty</span>(<span class="php-var">$this</span>-&gt;row[<span class="php-var">$this</span>-&gt;field_names[<span class="php-var">$num</span>]])) {
<span class="line" id="1261">1261: </span>            <span class="php-keyword1">return</span> <span class="php-keyword2">strtotime</span>(<span class="php-var">$this</span>-&gt;row[<span class="php-var">$this</span>-&gt;field_names[<span class="php-var">$num</span>]]);
<span class="line" id="1262">1262: </span>        }
<span class="line" id="1263">1263: </span>
<span class="line" id="1264">1264: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;row[<span class="php-var">$this</span>-&gt;field_names[<span class="php-var">$num</span>]];
<span class="line" id="1265">1265: </span>    } <span class="php-comment">// field_by_num</span>
<span class="line" id="1266">1266: </span>
<span class="line" id="1267">1267: </span>    <span class="php-comment">/**
</span><span class="line" id="1268">1268: </span><span class="php-comment">     * Returns the meta information about the field as an object with properties.
</span><span class="line" id="1269">1269: </span><span class="php-comment">     *
</span><span class="line" id="1270">1270: </span><span class="php-comment">     * @param int $num
</span><span class="line" id="1271">1271: </span><span class="php-comment">     * The number of the field.
</span><span class="line" id="1272">1272: </span><span class="php-comment">     *
</span><span class="line" id="1273">1273: </span><span class="php-comment">     * @return array
</span><span class="line" id="1274">1274: </span><span class="php-comment">     * Returns the associative array with properties.
</span><span class="line" id="1275">1275: </span><span class="php-comment">     *
</span><span class="line" id="1276">1276: </span><span class="php-comment">     * - $info[&quot;name&quot;] - name of the field.
</span><span class="line" id="1277">1277: </span><span class="php-comment">     * - $info[&quot;type&quot;] - type of the field.
</span><span class="line" id="1278">1278: </span><span class="php-comment">     * - $info[&quot;size&quot;] - size of the field.
</span><span class="line" id="1279">1279: </span><span class="php-comment">     * - $info[&quot;binary&quot;] - whether the filed is binary.
</span><span class="line" id="1280">1280: </span><span class="php-comment">     * - $info[&quot;numeric&quot;] - whether the filed is numeric.
</span><span class="line" id="1281">1281: </span><span class="php-comment">     * - $info[&quot;datetime&quot;] - whether the filed is datetime.
</span><span class="line" id="1282">1282: </span><span class="php-comment">     *
</span><span class="line" id="1283">1283: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="1284">1284: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="1285">1285: </span><span class="php-comment">     *
</span><span class="line" id="1286">1286: </span><span class="php-comment">     * @see MSSQL_DBWorker::field_by_num()
</span><span class="line" id="1287">1287: </span><span class="php-comment">     * @see MSSQL_DBWorker::field_name()
</span><span class="line" id="1288">1288: </span><span class="php-comment">     *
</span><span class="line" id="1289">1289: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1290">1290: </span><span class="php-comment">     */</span>
<span class="line" id="1291">1291: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> field_info_by_num(<span class="php-var">$num</span>)
<span class="line" id="1292">1292: </span>    {
<span class="line" id="1293">1293: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="1294">1294: </span>
<span class="line" id="1295">1295: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$this</span>-&gt;statement) {
<span class="line" id="1296">1296: </span>            <span class="php-var">$err</span> = <span class="php-quote">&quot;Result fetch error&quot;</span>;
<span class="line" id="1297">1297: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED, <span class="php-quote">&quot;&quot;</span>, [], <span class="php-var">$this</span>-&gt;get_last_query());
<span class="line" id="1298">1298: </span>        }
<span class="line" id="1299">1299: </span>
<span class="line" id="1300">1300: </span>        <span class="php-var">$info</span> = @sqlsrv_field_metadata(<span class="php-var">$this</span>-&gt;statement);
<span class="line" id="1301">1301: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$info</span>) {
<span class="line" id="1302">1302: </span>            <span class="php-var">$err</span> = <span class="php-var">$this</span>-&gt;sys_get_errors();
<span class="line" id="1303">1303: </span>
<span class="line" id="1304">1304: </span>            <span class="php-keyword1">throw</span> <span class="php-keyword1">new</span> DBWorkerException(<span class="php-var">$err</span>, DBWorker::ERR_QUERY_FAILED, <span class="php-quote">&quot;&quot;</span>, [], <span class="php-var">$this</span>-&gt;get_last_query());
<span class="line" id="1305">1305: </span>        }
<span class="line" id="1306">1306: </span>
<span class="line" id="1307">1307: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$info</span>[<span class="php-var">$num</span>])) {
<span class="line" id="1308">1308: </span>            <span class="php-keyword1">return</span> <span class="php-keyword1">false</span>;
<span class="line" id="1309">1309: </span>        }
<span class="line" id="1310">1310: </span>
<span class="line" id="1311">1311: </span>        <span class="php-var">$sqlsrv_type</span> = [];
<span class="line" id="1312">1312: </span>
<span class="line" id="1313">1313: </span>        <span class="php-var">$sqlsrv_type</span>[-<span class="php-num">5</span>] = <span class="php-quote">&quot;bigint&quot;</span>;
<span class="line" id="1314">1314: </span>        <span class="php-var">$sqlsrv_type</span>[-<span class="php-num">2</span>] = <span class="php-quote">&quot;binary&quot;</span>;
<span class="line" id="1315">1315: </span>        <span class="php-var">$sqlsrv_type</span>[-<span class="php-num">7</span>] = <span class="php-quote">&quot;bit&quot;</span>;
<span class="line" id="1316">1316: </span>        <span class="php-var">$sqlsrv_type</span>[<span class="php-num">1</span>] = <span class="php-quote">&quot;char&quot;</span>;
<span class="line" id="1317">1317: </span>        <span class="php-var">$sqlsrv_type</span>[<span class="php-num">91</span>] = <span class="php-quote">&quot;date&quot;</span>;
<span class="line" id="1318">1318: </span>        <span class="php-var">$sqlsrv_type</span>[<span class="php-num">93</span>] = <span class="php-quote">&quot;datetime&quot;</span>;
<span class="line" id="1319">1319: </span>
<span class="line" id="1320">1320: </span>        <span class="php-var">$sqlsrv_type</span>[-<span class="php-num">155</span>] = <span class="php-quote">&quot;datetimeoffset&quot;</span>;
<span class="line" id="1321">1321: </span>        <span class="php-var">$sqlsrv_type</span>[<span class="php-num">3</span>] = <span class="php-quote">&quot;decimal&quot;</span>;
<span class="line" id="1322">1322: </span>        <span class="php-var">$sqlsrv_type</span>[<span class="php-num">6</span>] = <span class="php-quote">&quot;float&quot;</span>;
<span class="line" id="1323">1323: </span>        <span class="php-var">$sqlsrv_type</span>[-<span class="php-num">4</span>] = <span class="php-quote">&quot;image&quot;</span>;
<span class="line" id="1324">1324: </span>        <span class="php-var">$sqlsrv_type</span>[<span class="php-num">4</span>] = <span class="php-quote">&quot;int&quot;</span>;
<span class="line" id="1325">1325: </span>        <span class="php-var">$sqlsrv_type</span>[-<span class="php-num">8</span>] = <span class="php-quote">&quot;nchar&quot;</span>;
<span class="line" id="1326">1326: </span>
<span class="line" id="1327">1327: </span>        <span class="php-var">$sqlsrv_type</span>[-<span class="php-num">10</span>] = <span class="php-quote">&quot;ntext&quot;</span>;
<span class="line" id="1328">1328: </span>        <span class="php-var">$sqlsrv_type</span>[<span class="php-num">2</span>] = <span class="php-quote">&quot;numeric&quot;</span>;
<span class="line" id="1329">1329: </span>        <span class="php-var">$sqlsrv_type</span>[-<span class="php-num">9</span>] = <span class="php-quote">&quot;nvarchar&quot;</span>;
<span class="line" id="1330">1330: </span>        <span class="php-var">$sqlsrv_type</span>[<span class="php-num">7</span>] = <span class="php-quote">&quot;real&quot;</span>;
<span class="line" id="1331">1331: </span>        <span class="php-var">$sqlsrv_type</span>[<span class="php-num">5</span>] = <span class="php-quote">&quot;smallint&quot;</span>;
<span class="line" id="1332">1332: </span>        <span class="php-var">$sqlsrv_type</span>[-<span class="php-num">1</span>] = <span class="php-quote">&quot;text&quot;</span>;
<span class="line" id="1333">1333: </span>
<span class="line" id="1334">1334: </span>        <span class="php-var">$sqlsrv_type</span>[-<span class="php-num">154</span>] = <span class="php-quote">&quot;time&quot;</span>;
<span class="line" id="1335">1335: </span>        <span class="php-var">$sqlsrv_type</span>[-<span class="php-num">6</span>] = <span class="php-quote">&quot;tinyint&quot;</span>;
<span class="line" id="1336">1336: </span>        <span class="php-var">$sqlsrv_type</span>[-<span class="php-num">151</span>] = <span class="php-quote">&quot;udt&quot;</span>;
<span class="line" id="1337">1337: </span>        <span class="php-var">$sqlsrv_type</span>[-<span class="php-num">11</span>] = <span class="php-quote">&quot;uniqueidentifier&quot;</span>;
<span class="line" id="1338">1338: </span>        <span class="php-var">$sqlsrv_type</span>[-<span class="php-num">3</span>] = <span class="php-quote">&quot;varbinary&quot;</span>;
<span class="line" id="1339">1339: </span>        <span class="php-var">$sqlsrv_type</span>[<span class="php-num">12</span>] = <span class="php-quote">&quot;varchar&quot;</span>;
<span class="line" id="1340">1340: </span>        <span class="php-var">$sqlsrv_type</span>[-<span class="php-num">152</span>] = <span class="php-quote">&quot;xml&quot;</span>;
<span class="line" id="1341">1341: </span>
<span class="line" id="1342">1342: </span>        <span class="php-var">$field_info</span> = [];
<span class="line" id="1343">1343: </span>
<span class="line" id="1344">1344: </span>        <span class="php-var">$field_info</span>[<span class="php-quote">&quot;name&quot;</span>] = <span class="php-var">$info</span>[<span class="php-var">$num</span>][<span class="php-quote">&quot;Name&quot;</span>];
<span class="line" id="1345">1345: </span>        <span class="php-var">$field_info</span>[<span class="php-quote">&quot;type&quot;</span>] = <span class="php-var">$info</span>[<span class="php-var">$num</span>][<span class="php-quote">&quot;Type&quot;</span>];
<span class="line" id="1346">1346: </span>        <span class="php-var">$field_info</span>[<span class="php-quote">&quot;size&quot;</span>] = <span class="php-var">$info</span>[<span class="php-var">$num</span>][<span class="php-quote">&quot;Size&quot;</span>];
<span class="line" id="1347">1347: </span>
<span class="line" id="1348">1348: </span>        <span class="php-var">$field_info</span>[<span class="php-quote">&quot;binary&quot;</span>] = <span class="php-num">0</span>;
<span class="line" id="1349">1349: </span>        <span class="php-var">$field_info</span>[<span class="php-quote">&quot;numeric&quot;</span>] = <span class="php-num">0</span>;
<span class="line" id="1350">1350: </span>
<span class="line" id="1351">1351: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$field_info</span>[<span class="php-quote">&quot;type&quot;</span>])) {
<span class="line" id="1352">1352: </span>            <span class="php-keyword1">if</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$field_info</span>[<span class="php-quote">&quot;type&quot;</span>], [-<span class="php-num">5</span>, <span class="php-num">3</span>, <span class="php-num">6</span>, <span class="php-num">4</span>, <span class="php-num">2</span>, <span class="php-num">7</span>, <span class="php-num">5</span>, -<span class="php-num">6</span>])) {
<span class="line" id="1353">1353: </span>                <span class="php-var">$field_info</span>[<span class="php-quote">&quot;numeric&quot;</span>] = <span class="php-num">1</span>;
<span class="line" id="1354">1354: </span>            }
<span class="line" id="1355">1355: </span>            <span class="php-keyword1">elseif</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$field_info</span>[<span class="php-quote">&quot;type&quot;</span>], [-<span class="php-num">2</span>, -<span class="php-num">4</span>, -<span class="php-num">3</span>])) {
<span class="line" id="1356">1356: </span>                <span class="php-var">$field_info</span>[<span class="php-quote">&quot;binary&quot;</span>] = <span class="php-num">1</span>;
<span class="line" id="1357">1357: </span>            }
<span class="line" id="1358">1358: </span>            <span class="php-keyword1">elseif</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$field_info</span>[<span class="php-quote">&quot;type&quot;</span>], [<span class="php-num">91</span>, <span class="php-num">93</span>])) {
<span class="line" id="1359">1359: </span>                <span class="php-var">$field_info</span>[<span class="php-quote">&quot;datetime&quot;</span>] = <span class="php-num">1</span>;
<span class="line" id="1360">1360: </span>            }
<span class="line" id="1361">1361: </span>            <span class="php-keyword1">elseif</span> (<span class="php-keyword2">in_array</span>(<span class="php-var">$field_info</span>[<span class="php-quote">&quot;type&quot;</span>], [<span class="php-num">1</span>, -<span class="php-num">8</span>, -<span class="php-num">10</span>, -<span class="php-num">9</span>, -<span class="php-num">1</span>, <span class="php-num">12</span>])) {
<span class="line" id="1362">1362: </span>                <span class="php-var">$field_info</span>[<span class="php-quote">&quot;string&quot;</span>] = <span class="php-num">1</span>;
<span class="line" id="1363">1363: </span>            }
<span class="line" id="1364">1364: </span>
<span class="line" id="1365">1365: </span>            <span class="php-keyword1">if</span> (<span class="php-keyword1">isset</span>(<span class="php-var">$sqlsrv_type</span>[<span class="php-var">$field_info</span>[<span class="php-quote">&quot;type&quot;</span>]])) {
<span class="line" id="1366">1366: </span>                <span class="php-var">$field_info</span>[<span class="php-quote">&quot;type&quot;</span>] = <span class="php-var">$sqlsrv_type</span>[<span class="php-var">$field_info</span>[<span class="php-quote">&quot;type&quot;</span>]];
<span class="line" id="1367">1367: </span>            } <span class="php-keyword1">else</span> {
<span class="line" id="1368">1368: </span>                <span class="php-var">$field_info</span>[<span class="php-quote">&quot;type&quot;</span>] = <span class="php-quote">&quot;undefined&quot;</span>;
<span class="line" id="1369">1369: </span>            }
<span class="line" id="1370">1370: </span>        }
<span class="line" id="1371">1371: </span>
<span class="line" id="1372">1372: </span>        <span class="php-keyword1">return</span> <span class="php-var">$field_info</span>;
<span class="line" id="1373">1373: </span>    } <span class="php-comment">// field_info_by_num</span>
<span class="line" id="1374">1374: </span>
<span class="line" id="1375">1375: </span>    <span class="php-comment">/**
</span><span class="line" id="1376">1376: </span><span class="php-comment">     * Returns the name of the field by number.
</span><span class="line" id="1377">1377: </span><span class="php-comment">     *
</span><span class="line" id="1378">1378: </span><span class="php-comment">     * @param int $num
</span><span class="line" id="1379">1379: </span><span class="php-comment">     * The number of the field.
</span><span class="line" id="1380">1380: </span><span class="php-comment">     *
</span><span class="line" id="1381">1381: </span><span class="php-comment">     * @return string|null
</span><span class="line" id="1382">1382: </span><span class="php-comment">     * Returns the name of the field by number.
</span><span class="line" id="1383">1383: </span><span class="php-comment">     *
</span><span class="line" id="1384">1384: </span><span class="php-comment">     * @throws DBWorkerException
</span><span class="line" id="1385">1385: </span><span class="php-comment">     * It throws an exception in the case of any errors.
</span><span class="line" id="1386">1386: </span><span class="php-comment">     *
</span><span class="line" id="1387">1387: </span><span class="php-comment">     * @see MSSQL_DBWorker::field_by_num()
</span><span class="line" id="1388">1388: </span><span class="php-comment">     * @see MSSQL_DBWorker::field_info_by_num()
</span><span class="line" id="1389">1389: </span><span class="php-comment">     *
</span><span class="line" id="1390">1390: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1391">1391: </span><span class="php-comment">     */</span>
<span class="line" id="1392">1392: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> field_name(<span class="php-var">$num</span>)
<span class="line" id="1393">1393: </span>    {
<span class="line" id="1394">1394: </span>        <span class="php-var">$this</span>-&gt;check_connection();
<span class="line" id="1395">1395: </span>
<span class="line" id="1396">1396: </span>        <span class="php-var">$info</span> = <span class="php-var">$this</span>-&gt;field_info_by_num(<span class="php-var">$num</span>);
<span class="line" id="1397">1397: </span>        <span class="php-keyword1">if</span> (!<span class="php-var">$info</span>) {
<span class="line" id="1398">1398: </span>            <span class="php-keyword1">return</span> <span class="php-keyword1">null</span>;
<span class="line" id="1399">1399: </span>        }
<span class="line" id="1400">1400: </span>
<span class="line" id="1401">1401: </span>        <span class="php-keyword1">return</span> <span class="php-var">$info</span>[<span class="php-quote">&quot;name&quot;</span>] ?? <span class="php-quote">&quot;&quot;</span>;
<span class="line" id="1402">1402: </span>    } <span class="php-comment">// field_name</span>
<span class="line" id="1403">1403: </span>
<span class="line" id="1404">1404: </span>    <span class="php-comment">/**
</span><span class="line" id="1405">1405: </span><span class="php-comment">     * Escapes the string so that it can be used in the query without causing an error.
</span><span class="line" id="1406">1406: </span><span class="php-comment">     *
</span><span class="line" id="1407">1407: </span><span class="php-comment">     * @param string $str
</span><span class="line" id="1408">1408: </span><span class="php-comment">     * The string to be escaped.
</span><span class="line" id="1409">1409: </span><span class="php-comment">     *
</span><span class="line" id="1410">1410: </span><span class="php-comment">     * @return string
</span><span class="line" id="1411">1411: </span><span class="php-comment">     * Returns the escaped string.
</span><span class="line" id="1412">1412: </span><span class="php-comment">     *
</span><span class="line" id="1413">1413: </span><span class="php-comment">     * @see MSSQL_DBWorker::format_date()
</span><span class="line" id="1414">1414: </span><span class="php-comment">     * @see MSSQL_DBWorker::format_datetime()
</span><span class="line" id="1415">1415: </span><span class="php-comment">     *
</span><span class="line" id="1416">1416: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1417">1417: </span><span class="php-comment">     */</span>
<span class="line" id="1418">1418: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> escape(<span class="php-var">$str</span>)
<span class="line" id="1419">1419: </span>    {
<span class="line" id="1420">1420: </span>        <span class="php-keyword1">return</span> <span class="php-keyword2">str_replace</span>(<span class="php-quote">&quot;'&quot;</span>, <span class="php-quote">&quot;''&quot;</span>, <span class="php-quote">&quot;</span><span class="php-var">$str</span><span class="php-quote">&quot;</span>);
<span class="line" id="1421">1421: </span>    } <span class="php-comment">// escape</span>
<span class="line" id="1422">1422: </span>
<span class="line" id="1423">1423: </span>    <span class="php-comment">/**
</span><span class="line" id="1424">1424: </span><span class="php-comment">     * Formats the date to a string compatible for the corresponding database.
</span><span class="line" id="1425">1425: </span><span class="php-comment">     *
</span><span class="line" id="1426">1426: </span><span class="php-comment">     * @param int $date
</span><span class="line" id="1427">1427: </span><span class="php-comment">     * The date value as timestamp.
</span><span class="line" id="1428">1428: </span><span class="php-comment">     *
</span><span class="line" id="1429">1429: </span><span class="php-comment">     * @return string
</span><span class="line" id="1430">1430: </span><span class="php-comment">     * Returns the string representation of the date compatible for the corresponding database.
</span><span class="line" id="1431">1431: </span><span class="php-comment">     *
</span><span class="line" id="1432">1432: </span><span class="php-comment">     * @see MSSQL_DBWorker::escape()
</span><span class="line" id="1433">1433: </span><span class="php-comment">     * @see MSSQL_DBWorker::format_datetime()
</span><span class="line" id="1434">1434: </span><span class="php-comment">     *
</span><span class="line" id="1435">1435: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1436">1436: </span><span class="php-comment">     */</span>
<span class="line" id="1437">1437: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> format_date(<span class="php-var">$date</span>)
<span class="line" id="1438">1438: </span>    {
<span class="line" id="1439">1439: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$date</span>)) {
<span class="line" id="1440">1440: </span>            <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;quotes_or_null(<span class="php-quote">&quot;&quot;</span>);
<span class="line" id="1441">1441: </span>        }
<span class="line" id="1442">1442: </span>
<span class="line" id="1443">1443: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;quotes_or_null(<span class="php-keyword2">date</span>(<span class="php-quote">&quot;Ymd&quot;</span>, <span class="php-var">$date</span>));
<span class="line" id="1444">1444: </span>    } <span class="php-comment">// format_date</span>
<span class="line" id="1445">1445: </span>
<span class="line" id="1446">1446: </span>    <span class="php-comment">/**
</span><span class="line" id="1447">1447: </span><span class="php-comment">     * Formats the date/time to a string compatible for the corresponding database.
</span><span class="line" id="1448">1448: </span><span class="php-comment">     *
</span><span class="line" id="1449">1449: </span><span class="php-comment">     * @param int $datetime
</span><span class="line" id="1450">1450: </span><span class="php-comment">     * The date/time value as timestamp.
</span><span class="line" id="1451">1451: </span><span class="php-comment">     *
</span><span class="line" id="1452">1452: </span><span class="php-comment">     * @return string
</span><span class="line" id="1453">1453: </span><span class="php-comment">     * Returns the string representation of the date/time compatible for the corresponding database.
</span><span class="line" id="1454">1454: </span><span class="php-comment">     *
</span><span class="line" id="1455">1455: </span><span class="php-comment">     * @see MSSQL_DBWorker::escape()
</span><span class="line" id="1456">1456: </span><span class="php-comment">     * @see MSSQL_DBWorker::format_date()
</span><span class="line" id="1457">1457: </span><span class="php-comment">     *
</span><span class="line" id="1458">1458: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1459">1459: </span><span class="php-comment">     */</span>
<span class="line" id="1460">1460: </span>    <span class="php-keyword1">public</span> <span class="php-keyword1">function</span> format_datetime(<span class="php-var">$datetime</span>)
<span class="line" id="1461">1461: </span>    {
<span class="line" id="1462">1462: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$datetime</span>)) {
<span class="line" id="1463">1463: </span>            <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;quotes_or_null(<span class="php-quote">&quot;&quot;</span>);
<span class="line" id="1464">1464: </span>        }
<span class="line" id="1465">1465: </span>
<span class="line" id="1466">1466: </span>        <span class="php-keyword1">return</span> <span class="php-var">$this</span>-&gt;quotes_or_null(<span class="php-keyword2">date</span>(<span class="php-quote">&quot;Ymd H:i:s&quot;</span>, <span class="php-var">$datetime</span>));
<span class="line" id="1467">1467: </span>    } <span class="php-comment">// format_datetime</span>
<span class="line" id="1468">1468: </span>
<span class="line" id="1469">1469: </span>    <span class="php-comment">/**
</span><span class="line" id="1470">1470: </span><span class="php-comment">     * Prepares the value for putting to a query depending on its type. It does escaping, formatting
</span><span class="line" id="1471">1471: </span><span class="php-comment">     * and quotation if necessary.
</span><span class="line" id="1472">1472: </span><span class="php-comment">     *
</span><span class="line" id="1473">1473: </span><span class="php-comment">     * @param mixed $value
</span><span class="line" id="1474">1474: </span><span class="php-comment">     * The value to be formatted.
</span><span class="line" id="1475">1475: </span><span class="php-comment">     *
</span><span class="line" id="1476">1476: </span><span class="php-comment">     * @param int $type
</span><span class="line" id="1477">1477: </span><span class="php-comment">     * The type of the value.
</span><span class="line" id="1478">1478: </span><span class="php-comment">     *
</span><span class="line" id="1479">1479: </span><span class="php-comment">     * @return string
</span><span class="line" id="1480">1480: </span><span class="php-comment">     * Returns the prepared value.
</span><span class="line" id="1481">1481: </span><span class="php-comment">     *
</span><span class="line" id="1482">1482: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1483">1483: </span><span class="php-comment">     */</span>
<span class="line" id="1484">1484: </span>    <span class="php-keyword1">function</span> prepare_for_query(<span class="php-var">$value</span>, <span class="php-var">$type</span>)
<span class="line" id="1485">1485: </span>    {
<span class="line" id="1486">1486: </span>        <span class="php-keyword1">if</span> (<span class="php-keyword1">empty</span>(<span class="php-var">$value</span>) &amp;&amp; (string)<span class="php-var">$value</span> != <span class="php-quote">&quot;0&quot;</span>) {
<span class="line" id="1487">1487: </span>            <span class="php-keyword1">return</span> <span class="php-quote">&quot;null&quot;</span>;
<span class="line" id="1488">1488: </span>        } <span class="php-keyword1">else</span> {
<span class="line" id="1489">1489: </span>            <span class="php-keyword1">return</span> match (<span class="php-var">$type</span>) {
<span class="line" id="1490">1490: </span>                DBWorker::DB_NUMBER =&gt; <span class="php-var">$this</span>-&gt;number_or_null(<span class="php-var">$value</span>),
<span class="line" id="1491">1491: </span>                DBWorker::DB_DATETIME =&gt; <span class="php-var">$this</span>-&gt;format_datetime(<span class="php-var">$value</span>),
<span class="line" id="1492">1492: </span>                DBWorker::DB_DATE =&gt; <span class="php-var">$this</span>-&gt;format_date(<span class="php-var">$value</span>),
<span class="line" id="1493">1493: </span>                <span class="php-keyword1">default</span> =&gt; <span class="php-var">$this</span>-&gt;quotes_or_null(<span class="php-var">$value</span>)
<span class="line" id="1494">1494: </span>            };
<span class="line" id="1495">1495: </span>        }
<span class="line" id="1496">1496: </span>    } <span class="php-comment">// prepare_for_query</span>
<span class="line" id="1497">1497: </span>
<span class="line" id="1498">1498: </span>    <span class="php-comment">/**
</span><span class="line" id="1499">1499: </span><span class="php-comment">     * Builds simple select query based on parameters.
</span><span class="line" id="1500">1500: </span><span class="php-comment">     *
</span><span class="line" id="1501">1501: </span><span class="php-comment">     * It is used for building queries with limits.
</span><span class="line" id="1502">1502: </span><span class="php-comment">     *
</span><span class="line" id="1503">1503: </span><span class="php-comment">     * @param string $table
</span><span class="line" id="1504">1504: </span><span class="php-comment">     * The name of the table.
</span><span class="line" id="1505">1505: </span><span class="php-comment">     *
</span><span class="line" id="1506">1506: </span><span class="php-comment">     * @param array $fields
</span><span class="line" id="1507">1507: </span><span class="php-comment">     * The list of request fields.
</span><span class="line" id="1508">1508: </span><span class="php-comment">     *
</span><span class="line" id="1509">1509: </span><span class="php-comment">     * @param string $where_clause
</span><span class="line" id="1510">1510: </span><span class="php-comment">     * The where clause that should restrict the result.
</span><span class="line" id="1511">1511: </span><span class="php-comment">     *
</span><span class="line" id="1512">1512: </span><span class="php-comment">     * @param string $order_clause
</span><span class="line" id="1513">1513: </span><span class="php-comment">     * The order clause to sort the results.
</span><span class="line" id="1514">1514: </span><span class="php-comment">     *
</span><span class="line" id="1515">1515: </span><span class="php-comment">     * @param int $limit
</span><span class="line" id="1516">1516: </span><span class="php-comment">     * The limit how many records shoud be loaded. 0 for unlimited.
</span><span class="line" id="1517">1517: </span><span class="php-comment">     *
</span><span class="line" id="1518">1518: </span><span class="php-comment">     * @return string
</span><span class="line" id="1519">1519: </span><span class="php-comment">     * Returns the built query.
</span><span class="line" id="1520">1520: </span><span class="php-comment">     *
</span><span class="line" id="1521">1521: </span><span class="php-comment">     * @author Oleg Schildt
</span><span class="line" id="1522">1522: </span><span class="php-comment">     */</span>
<span class="line" id="1523">1523: </span>    <span class="php-keyword1">function</span> build_select_query(<span class="php-var">$table</span>, <span class="php-var">$fields</span>, <span class="php-var">$where_clause</span>, <span class="php-var">$order_clause</span>, <span class="php-var">$limit</span>)
<span class="line" id="1524">1524: </span>    {
<span class="line" id="1525">1525: </span>        <span class="php-var">$query</span> = <span class="php-quote">&quot;select\n&quot;</span>;
<span class="line" id="1526">1526: </span>
<span class="line" id="1527">1527: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$limit</span>) &amp;&amp; <span class="php-keyword2">is_numeric</span>(<span class="php-var">$limit</span>)) {
<span class="line" id="1528">1528: </span>            <span class="php-var">$query</span> .= <span class="php-quote">&quot;top &quot;</span> . <span class="php-var">$limit</span> . <span class="php-quote">&quot;\n&quot;</span>;
<span class="line" id="1529">1529: </span>        }
<span class="line" id="1530">1530: </span>
<span class="line" id="1531">1531: </span>        <span class="php-var">$query</span> .= <span class="php-keyword2">implode</span>(<span class="php-quote">&quot;, &quot;</span>, <span class="php-var">$fields</span>) . <span class="php-quote">&quot;\n&quot;</span>;
<span class="line" id="1532">1532: </span>
<span class="line" id="1533">1533: </span>        <span class="php-var">$query</span> .= <span class="php-quote">&quot;from &quot;</span> . <span class="php-var">$table</span> . <span class="php-quote">&quot;\n&quot;</span>;
<span class="line" id="1534">1534: </span>
<span class="line" id="1535">1535: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$where_clause</span>)) {
<span class="line" id="1536">1536: </span>            <span class="php-var">$query</span> .= <span class="php-var">$where_clause</span> . <span class="php-quote">&quot;\n&quot;</span>;
<span class="line" id="1537">1537: </span>        }
<span class="line" id="1538">1538: </span>
<span class="line" id="1539">1539: </span>        <span class="php-keyword1">if</span> (!<span class="php-keyword1">empty</span>(<span class="php-var">$where_clause</span>)) {
<span class="line" id="1540">1540: </span>            <span class="php-var">$query</span> .= <span class="php-var">$order_clause</span> . <span class="php-quote">&quot;\n&quot;</span>;
<span class="line" id="1541">1541: </span>        }
<span class="line" id="1542">1542: </span>
<span class="line" id="1543">1543: </span>        <span class="php-keyword1">return</span> <span class="php-var">$query</span>;
<span class="line" id="1544">1544: </span>    } <span class="php-comment">// build_select_query</span>
<span class="line" id="1545">1545: </span>} <span class="php-comment">// MSSQL_DBWorker</span>
</code>
</pre>
</div>
                    
                    <div id="footer">
                        Generated on 2025-03-26 06:57 with <a href="https://github.com/oschildt/PhpDoxy" target="_blank">PhpDoxy</a>
                    </div>                    
                </div>
            </div>
        </div>

        <script src="resources/jquery-3.2.1.min.js"></script>
        <script src="resources/jquery-ui-1.12.1.min.js"></script>

        <script src="elementlist.js"></script>
        <script src="resources/main.js"></script>
        
        <script src="resources/jquery.iviewer.js" type="text/javascript"></script>
        <script src="resources/jquery.mousewheel.js" type="text/javascript"></script>
        
    </body>
</html>


